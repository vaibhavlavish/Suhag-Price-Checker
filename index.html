<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Suhag Price Checker</title>

    <link rel="manifest" href="manifest.json">

    <meta name="theme-color" content="#1a1a1a">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SuhagPrice">
    <link rel="apple-touch-icon" href="icon-192.png">

    <script type="module">
        // Import the functions you need from the Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
          apiKey: "AIzaSyDaRjbdCnfx5-C4OXQaByZMxK2r0Cu19bI",
          authDomain: "suhag-f53e4.firebaseapp.com",
          databaseURL: "https://suhag-f53e4-default-rtdb.asia-southeast1.firebasedatabase.app",
          projectId: "suhag-f53e4",
          storageBucket: "suhag-f53e4.firebasestorage.app",
          messagingSenderId: "231258063675",
          appId: "1:231258063675:web:1c79c2a0d4d5796a6d2d1e",
          measurementId: "G-MJ1BBWZFVW"
        };


        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // Expose Firebase functions to the global scope for the main script
        window.firebaseDB = db;
        window.dbRef = ref;
        window.dbSet = set;
        window.dbOnValue = onValue;
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            touch-action: manipulation;
        }
        #taskbar {
            background-color: #1a1a1a;
            color: white;
            padding: 8px 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: nowrap;
            gap: 4px;
            -webkit-overflow-scrolling: touch;
            position: relative;
        }
        #taskbar button {
            background-color: #333;
            color: white;
            border: none;
            padding: 10px 16px;
            margin: 0;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            white-space: nowrap;
            flex: 1;
            max-width: 120px;
        }
        #taskbar button:hover {
            background-color: #555;
        }
        #taskbar button.active {
            background-color: #4CAF50;
        }
        #options-btn {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            padding: 8px 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #options-menu {
            display: none;
            position: absolute;
            top: 100%;
            right: 12px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.2);
            overflow: hidden;
            z-index: 1000;
            min-width: 180px;
            margin-top: 4px;
        }
        #options-menu.show {
            display: block;
            animation: fadeIn 0.2s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-8px); }
            to { opacity: 1; transform: translateY(0); }
        }
        #options-menu button {
            display: block;
            width: 100%;
            background: none;
            border: none;
            padding: 14px 16px;
            text-align: left;
            font-size: 15px;
            color: #333;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }
        #options-menu button:last-child {
            border-bottom: none;
        }
        #options-menu button.danger {
            color: #d32f2f;
        }
        #options-menu button.backup {
            color: #2196F3;
            font-weight: 600;
        }
        #options-menu button.restore {
            color: #FF9800;
            font-weight: 600;
        }
        #options-menu button.danger:hover {
            background-color: #ffebee;
        }
        #main-screen {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px 15px;
            background-color: #f5f5f5;
            overflow-y: auto;
            min-height: calc(100vh - 60px);
            /* Center the content block */
            width: 100%;
            max-width: 480px; /* Max width for content */
            margin: 0 auto;
        }
        #loose-calculator {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px 15px;
            background-color: #f5f5f5;
            overflow-y: auto;
            min-height: calc(100vh - 60px);
            width: 100%;
            max-width: 420px;
            margin: 0 auto;
        }
        #barcode, #loose-weight { /* Added loose-weight here for styling */
            font-size: 20px;
            padding: 16px;
            width: 100%;
            max-width: 100%;
            text-align: center;
            border: 2px solid #ddd;
            border-radius: 10px;
            margin-bottom: 16px;
            background: white;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }
        #barcode:focus, #loose-weight:focus {
            border-color: #4CAF50;
            outline: none;
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.2);
        }
        #product-code {
            font-size: 16px;
            color: #555;
            margin: 8px 0;
            text-align: center;
            width: 100%;
            word-wrap: break-word;
            cursor: pointer; /* Changed to pointer to indicate clickability */
            user-select: none; /* Prevent text selection on double tap */
        }
        #product-code:active {
            color: #333;
            transform: scale(0.99);
        }
        #price-display {
            font-size: 48px;
            font-weight: 700;
            color: #4CAF50;
            margin: 8px 0;
            opacity: 0;
            transition: opacity 0.4s ease;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        #loose-price-display { /* Style for loose calculator display */
            font-size: 48px;
            font-weight: 700;
            color: #4CAF50;
            margin: 20px 0;
            text-align: center;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        #price-display.show {
            opacity: 1;
        }

        /* --- NEW BUTTON LAYOUT STYLES --- */
        #main-buttons-container {
            width: 100%;
            max-width: 420px; /* Match the modal width */
            display: flex;
            flex-direction: column;
            gap: 8px; /* Space between button rows */
            margin-top: 16px;
        }
        .button-row {
            display: flex;
            gap: 8px;
        }
        .full-width-btn {
            width: 100%;
            display: block;
        }
        .half-width-btn {
            flex: 1 1 45%; /* Grow and shrink, start at 45% */
        }
        #detail-btn, #add-to-cart-btn, #alter-btn, .clear-btn, #cart-btn, #loose-add-to-cart-btn, #loose-alter-btn {
            margin: 0; /* Reset margins */
            padding: 12px 20px;
            font-size: 16px;
            font-weight: 600;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            /* display: none; Hide all by default */
            box-shadow: 0 3px 8px rgba(0,0,0,0.2);
            transition: all 0.2s;
            text-align: center; /* Ensure text is centered */
        }
        
        /* Specific display logic fixes */
        #detail-btn, #add-to-cart-btn, #alter-btn, .clear-btn, #cart-btn {
            display: none;
        }
        /* Loose buttons are always visible in their section, layout handled by flex */

        #detail-btn:active, #add-to-cart-btn:active, #alter-btn:active, .clear-btn:active, #cart-btn:active, #loose-add-to-cart-btn:active, #loose-alter-btn:active {
            transform: translateY(1px);
            box-shadow: 0 1px 4px rgba(0,0,0,0.2);
        }
        #detail-btn {
            background-color: #2196F3;
        }
        #add-to-cart-btn, #loose-add-to-cart-btn {
            background-color: #4CAF50; /* Green for add to cart */
        }
        #alter-btn, #loose-alter-btn {
            background-color: #FF9800;
        }
        .clear-btn {
            background-color: #f44336;
        }
        #cart-btn {
            background-color: #555;
            position: relative; /* For the counter */
        }
        #cart-counter {
            position: absolute;
            top: -5px;
            right: 10px;
            background: #f44336;
            color: white;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            font-size: 14px;
            line-height: 22px;
            text-align: center;
            font-weight: bold;
        }
        /* --- END NEW BUTTON LAYOUT STYLES --- */
        
        /* Reused Modal Styles */
        #detail-modal, #alter-modal, #loose-alter-modal, #cart-modal, #custom-modal, #old-gold-modal { /* Added old-gold-modal */
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 15px;
            animation: fadeIn 0.2s ease;
        }
        #detail-content, #alter-content, #loose-alter-content, #cart-content, #custom-modal-content, #old-gold-content { /* Added old-gold-content */
            background: white;
            padding: 20px;
            border-radius: 16px;
            max-width: 420px; /* Consistent width */
            width: 100%;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            max-height: 90vh;
            display: flex; /* Use flex for easier content management */
            flex-direction: column;
        }
        #detail-content h3, #alter-content h3, #loose-alter-content h3, #cart-content h3, #custom-modal-content h3, #old-gold-content h3 {
            margin: 0 0 16px 0;
            color: #333;
            font-size: 20px;
            text-align: center;
            border-bottom: 1px solid #eee;
            padding-bottom: 12px;
        }
        #detail-content p {
            margin: 10px 0;
            font-size: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center; /* Ensures button aligns nicely */
            padding: 6px 0;
            border-bottom: 1px dashed #eee;
        }
        #detail-content p:last-of-type {
            border-bottom: none;
            font-weight: 600;
            font-size: 16px;
            color: #4CAF50;
        }
        #detail-content p strong {
            color: #333;
            min-width: 120px;
        }
        #close-modal {
            background-color: #f44336;
            color: white;
            border: none;
            padding: 10px 20px;
            margin-top: 16px;
            border-radius: 25px;
            cursor: pointer;
            width: 100%;
            font-size: 16px;
            font-weight: 600;
            box-shadow: 0 3px 8px rgba(244, 67, 54, 0.3);
        }
        #close-modal:active {
            transform: translateY(1px);
        }
        #alter-body p {
            margin: 10px 0;
            font-size: 15px;
            text-align: center;
            color: #666;
        }

        /* Style for the input group with up/down buttons */
        .input-with-stepper {
            display: flex;
            align-items: center;
            gap: 5px; /* Space between input and buttons */
            margin: 16px 0;
        }

        .input-with-stepper input[type="number"], .input-with-stepper input[type="text"] {
            flex-grow: 1; /* Allow input to take available space */
            margin: 0; /* Reset margin */
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            text-align: center;
        }
        .input-with-stepper input:focus {
            border-color: #4CAF50;
            outline: none;
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
        }

        .stepper-btn {
            background-color: #eee;
            color: #333;
            border: 1px solid #ccc;
            width: 38px; /* Fixed width for button */
            height: 38px; /* Fixed height for button */
            border-radius: 8px;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
            transition: background-color 0.1s;
            flex-shrink: 0; /* Prevent buttons from shrinking */
        }
        .stepper-btn:hover {
            background-color: #e0e0e0;
        }
        .stepper-btn:active {
            background-color: #d0d0d0;
            transform: translateY(1px);
        }
        /* Specific styling for the Making Charge input in alter modal */
        #new-making, #modal-loose-making-percent {
            margin: 0; /* Removed margin here as it's handled by parent div */
        }


        #alter-buttons {
            display: flex;
            gap: 10px;
            margin-top: 16px;
        }
        #alter-buttons button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            color: white;
            box-shadow: 0 3px 8px;
            transition: all 0.2s;
        }
        #update-making-btn {
            background-color: #4CAF50;
            box-shadow: 0 3px 8px rgba(76, 175, 80, 0.3);
        }
        #cancel-making-btn {
            background-color: #f44336;
            box-shadow: 0 3px 8px rgba(244, 67, 54, 0.3);
        }
        #alter-buttons button:active {
            transform: translateY(1px);
            box-shadow: 0 1px 4px;
        }
        /* Hidden sections - includes the new loose calculator */
        #update-rates, #excel-upload { 
            display: none;
            max-width: 100%;
            margin: 0 auto; /* Center the sections */
            background: white;
            padding: 20px 15px;
            border-radius: 12px; /* Add rounding */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05); /* Add shadow */
            flex: 1;
            overflow-y: auto;
            max-width: 480px; /* Match main screen width */
        }
        #update-rates h2, #excel-upload h2, #loose-calculator h2 {
            color: #333;
            font-size: 18px;
            margin-top: 0;
            text-align: center;
        }
        input, select, button, #excel-file {
            margin: 8px 0;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            width: 100%;
            font-size: 16px;
        }
        input:focus, select:focus {
            border-color: #4CAF50;
            outline: none;
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
        }
        /* Updated button selector to exclude new cart buttons and old gold */
        button:not(#taskbar button):not(#detail-btn):not(#alter-btn):not(#close-modal):not(#options-btn):not(#add-to-cart-btn):not(#cart-btn):not(.stepper-btn):not(#close-cart-modal):not(#clear-cart-btn):not(#clear-screen-btn):not(#loose-add-to-cart-btn):not(#loose-alter-btn):not(#add-old-gold-btn):not(.remove-old-gold-btn):not(.remove-item-btn) {
            background-color: #4CAF50;
            color: white;
            cursor: pointer;
            font-weight: 600;
            box-shadow: 0 3px 8px rgba(76, 175, 80, 0.3);
            margin: 4px 0;
            width: auto;
            padding: 10px 16px;
        }
        button:not(#taskbar button):not(#detail-btn):not(#alter-btn):not(#close-modal):not(#options-btn):not(#add-to-cart-btn):not(#cart-btn):not(.stepper-btn):not(#loose-add-to-cart-btn):not(#loose-alter-btn):not(#add-old-gold-btn):not(.remove-old-gold-btn):active {
            transform: translateY(1px);
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        #manage-stamps {
            margin-top: 20px;
            padding: 16px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #f9f9f9;
        }
        #manage-stamps h4 {
            margin: 0 0 12px 0;
            color: #333;
            font-size: 16px;
        }
        #manage-stamps hr {
            border: none;
            border-top: 1px solid #ccc;
        }
        .manage-row {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: end;
            margin-bottom: 12px;
        }
        .manage-row label {
            min-width: 140px;
            margin: 0;
        }
        .manage-row input, .manage-row select {
            flex: 1;
            min-width: 120px;
        }
        .manage-row button {
            flex-shrink: 0;
            width: auto;
            padding: 8px 12px;
            font-size: 14px;
        }
        #excel-info {
            background-color: #fff8e1;
            border: 1px solid #ffe082;
            color: #5d4037;
            padding: 12px;
            margin: 12px 0;
            border-radius: 8px;
            font-size: 14px;
        }
        label {
            display: block;
            margin: 12px 0 4px 0;
            font-weight: 600;
            font-size: 14px;
            color: #333;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 16px;
            font-size: 14px;
        }
        th, td {
            padding: 10px 8px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #333;
        }
        hr {
            border: none;
            border-top: 1px solid #eee;
            margin: 20px 0;
        }
        
        /* --- Badge for Taskbar Cart Button --- */
        #cart-btn-nav {
            position: relative;
        }
        .badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: #ef4444; /* Red */
            color: white;
            border-radius: 50%;
            padding: 2px 5px;
            font-size: 10px;
            font-weight: 700;
            min-width: 18px;
            text-align: center;
            line-height: 1.2;
        }

        /* --- NEW CART MODAL STYLES --- */
        #cart-items-container {
            flex-grow: 1; /* Allows list to scroll */
            overflow-y: auto;
            min-height: 100px; /* Ensures it has a size */
            max-height: 40vh; /* Prevents it from taking full modal height */
            padding-right: 5px;
            margin-bottom: 15px;
        }
        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px dashed #eee;
        }
        .cart-item-details {
            flex-grow: 1;
            margin-right: 10px;
            cursor: pointer; /* Clickable to view item */
        }
        .cart-item-details:hover {
            text-decoration: underline;
        }
        .cart-item-title {
            font-weight: 600;
            color: #333;
            font-size: 1.1em;
        }
        .cart-item-barcode {
            font-size: 0.9em;
            color: #777;
        }
        .cart-item-price {
            font-weight: 700;
            color: #4CAF50;
            font-size: 1.1em;
            flex-shrink: 0;
            text-align: right;
            min-width: 90px;
        }
        .remove-item-btn {
            background: #f44336;
            color: white;
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            padding: 0;
            font-size: 20px; /* Larger 'x' */
            font-weight: bold;
            cursor: pointer;
            margin-left: 10px;
            flex-shrink: 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: all 0.1s;
            /* FIXED: Flexbox centering */
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1; /* Reset line-height */
        }
        .remove-item-btn:hover {
            background: #d32f2f;
        }
        #cart-total-summary {
            padding-top: 15px;
            border-top: 2px solid #333;
            font-size: 1.3em;
            font-weight: 700;
            display: flex;
            flex-direction: column; /* Changed to column for detailed breakdown */
            gap: 5px;
            margin-bottom: 15px;
        }
        .empty-cart-message {
            text-align: center;
            color: #999;
            padding: 20px;
        }
        
        /* Custom Modal for Alerts/Confirms */
        #custom-modal-content {
            text-align: center;
        }
        #custom-modal-message {
            font-size: 1.1rem;
            color: #333;
            margin: 10px 0 20px 0;
        }
        #custom-modal-actions {
            display: flex;
            justify-content: center;
            gap: 10px;
        }
        #custom-modal-actions button {
            flex: 1;
        }

        /* --- OLD GOLD BUTTON & MODAL --- */
        #add-old-gold-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: #4CAF50;
            color: white;
            font-size: 30px;
            border: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 999;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-weight: bold;
            line-height: 1;
            padding: 0;
        }
        #add-old-gold-btn:active {
            transform: scale(0.95);
        }
        #old-gold-list {
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 15px;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 5px;
        }
        .old-gold-item-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid #eee;
            background: #fff;
        }
        .old-gold-item-row:last-child {
            border-bottom: none;
        }
        .remove-old-gold-btn {
            background: none;
            border: none;
            color: #f44336;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            padding: 0 5px;
            width: auto;
            margin: 0;
            box-shadow: none;
        }
        
        /* Auto Calc Styles */
        .base-calc-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
            padding: 8px;
            background: #f9f9f9;
            border-radius: 6px;
        }
        .base-calc-row label {
            margin: 0;
            flex: 1;
            font-size: 14px;
        }
        .base-calc-row input {
            width: 80px;
            padding: 8px;
            margin: 0;
            text-align: center;
        }
        
        /* Responsive adjustments */
        @media (min-width: 480px) {
            #taskbar {
                padding: 10px 16px;
            }
            #taskbar button {
                font-size: 15px;
                padding: 12px 18px;
            }
            #barcode, #loose-weight {
                font-size: 22px;
                padding: 18px;
            }
            #price-display, #loose-price-display {
                font-size: 56px;
            }
            #detail-content, #alter-content, #loose-alter-content, #cart-content, #custom-modal-content, #old-gold-content {
                max-width: 420px;
            }
            .manage-row {
                flex-wrap: nowrap;
            }
        }

        /* --- Cart Modal Button Row Styles --- */
        #cart-modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        #cart-modal-buttons button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            color: white;
            box-shadow: 0 3px 8px;
            transition: all 0.2s;
        }
        #close-cart-modal {
            background-color: #555;
            box-shadow: 0 3px 8px rgba(85, 85, 85, 0.3);
        }
        #clear-cart-btn {
            background-color: #f44336;
            box-shadow: 0 3px 8px rgba(244, 67, 54, 0.3);
        }
        #cart-modal-buttons button:active {
            transform: translateY(1px);
            box-shadow: 0 1px 4px;
        }
    </style>
</head>
<body>
    <div id="taskbar">
        <button onclick="showSection('main')" class="active">Main</button>
        <button onclick="showSection('loose-calculator')">Loose</button>
        
        <button id="cart-btn-nav" class="taskbar-btn" onclick="openCart()" style="max-width: 60px;">
            ðŸ›’
            <span id="cart-counter-nav" class="badge" style="display: none;">0</span>
        </button>
        <button id="options-btn" onclick="toggleOptions()">More</button>
        <div id="options-menu">
            <button onclick="showSection('update-rates')">Update Rates</button>
            <button onclick="showSection('excel-upload')">Upload Excel</button>
            <button onclick="downloadBackup()" class="backup">Download Backup</button>
            <button onclick="triggerRestore()" class="restore">Restore Backup (JSON)</button>
            <button onclick="clearAll()">Clear Screen</button>
            <button onclick="clearAllDataWrapper()" class="danger">Clear All Data (Cloud)</button>
        </div>
    </div>

    <input type="file" id="restore-file-input" accept=".json" style="display: none;" onchange="processRestoreFile()">

    <div id="main-screen">
        <input type="text" id="barcode" placeholder="Scan or enter barcode..." autofocus>
        <div id="product-code" onclick="toggleProductInfo()"></div> <h1 id="price-display">0.00</h1>
        
        <div id="main-buttons-container">
            <button onclick="clearAll()" class="clear-btn full-width-btn" id="clear-screen-btn">Clear Screen</button>
            
            <div class="button-row">
                <button id="detail-btn" class="half-width-btn" onclick="showDetails()">View Details</button>
                <button id="add-to-cart-btn" class="half-width-btn" onclick="addToCart()">Add to Cart</button>
            </div>
            
            <button id="alter-btn" class="full-width-btn" onclick="openAlterDialog()">Alter</button>
            
            <button id="cart-btn" class="full-width-btn" onclick="openCart()">
                ðŸ›’ View Cart
                <span id="cart-counter" class="badge" style="display: none;">0</span>
            </button>
        </div>
    </div>
    
    <button id="add-old-gold-btn" onclick="openOldGoldModal()">+</button>

    <div id="loose-calculator">
        <h2 style="display: none;">Loose Jewellery Price Calculator</h2>
        
        <input type="hidden" id="loose-metal-select" value="Gold">
        <input type="hidden" id="loose-stamp-select" value="750">
        <input type="hidden" id="loose-making-percent" value="35">
        
        <label for="loose-weight">Weight (Grams):</label>
        <input type="number" id="loose-weight" placeholder="Enter weight in grams" step="0.01" oninput="calculateLoosePrice()">
        
        <hr style="display: none;">

        <p style="text-align: center; font-size: 18px; font-weight: 600; color: #333;">Final Price:</p>
        <h1 id="loose-price-display">0.00</h1>

        <div id="loose-details" style="display: none;"></div>
        
        <button id="loose-clear-btn" onclick="clearLooseScreen()" 
            style="margin-top: 20px; background-color: #f44336; color: white; padding: 10px 20px; border-radius: 25px; font-weight: 600; box-shadow: 0 3px 8px rgba(244, 67, 54, 0.3);">
            Clear Screen
        </button>

        <button id="loose-add-to-cart-btn" class="full-width-btn" onclick="addToCartLoose()" style="margin-top: 10px; background-color: #4CAF50;">Add to Cart</button>
        <button id="loose-alter-btn" class="full-width-btn" onclick="openLooseAlterDialog()" style="margin-top: 10px; background-color: #FF9800;">Alter</button>
        <button onclick="showSection('main')" style="margin-top: 10px;">Back to Main</button>

        <label for="repair-amount">Other Amount (â‚¹):</label>
        <input type="number" id="repair-amount" placeholder="Enter amount" step="0.01">
        <button onclick="addRepairToCart()" style="margin-top: 10px; background-color: #4CAF50; color: white; padding: 12px; border-radius: 25px; font-weight: 600; border: none; box-shadow: 0 3px 8px rgba(76, 175, 80, 0.3); width: 100%;">Add to Cart</button>
    </div>
    <div id="detail-modal">
        <div id="detail-content">
            <h3>Product Details</h3>
            <div id="detail-body"></div>
            <button id="close-modal" onclick="closeModal('detail-modal')">Close</button>
        </div>
    </div>
    <div id="alter-modal">
        <div id="alter-content">
            <h3>Alter Making Charge</h3>
            <div id="alter-body"></div>
            <label for="new-making">New Making Charge (same unit):</label>
            <div class="input-with-stepper">
                <button class="stepper-btn" onclick="adjustMaking('new-making', -0.25)">-</button>
                <input type="number" id="new-making" step="0.25">
                <button class="stepper-btn" onclick="adjustMaking('new-making', 0.25)">+</button>
            </div>
            <div id="alter-buttons">
                <button id="update-making-btn" onclick="updateMaking()">Update</button>
                <button id="cancel-making-btn" onclick="closeModal('alter-modal')">Cancel</button>
            </div>
        </div>
    </div>
    
    <div id="loose-alter-modal">
        <div id="loose-alter-content">
            <h3>Loose Calculation Settings</h3>
            <div id="loose-alter-body">
                <label for="modal-loose-metal-select">Metal Type:</label>
                <select id="modal-loose-metal-select" onchange="populateModalStamps(this.value)">
                    <option value="Gold">Gold</option>
                    <option value="Silver">Silver</option>
                    <option value="PC">PC</option>
                </select>

                <label for="modal-loose-stamp-select">Stamp/Purity:</label>
                <select id="modal-loose-stamp-select"></select>

                <label for="modal-loose-making-percent">Making Charge (%):</label>
                <div class="input-with-stepper">
                    <button class="stepper-btn" onclick="adjustMaking('modal-loose-making-percent', -0.25)">-</button>
                    <input type="number" id="modal-loose-making-percent" placeholder="e.g., 35" step="0.25">
                    <button class="stepper-btn" onclick="adjustMaking('modal-loose-making-percent', 0.25)">+</button>
                </div>
            </div>
            <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 16px;">
                <button id="save-loose-defaults-btn" onclick="saveLooseDefaultsToCloud()" 
                    style="background-color: #2196F3; color: white; padding: 12px; border-radius: 25px; font-weight: 600; border: none; box-shadow: 0 3px 8px rgba(33, 150, 243, 0.3); width: 100%;">
                    Save Current As Default
                </button>
                <div id="modal-buttons" style="display: flex; gap: 10px;">
                    <button id="update-loose-inputs-btn" onclick="updateLooseInputs()" style="flex: 1; background-color: #4CAF50; color: white;">Apply Changes</button>
                    <button id="cancel-loose-btn" onclick="closeModal('loose-alter-modal')" style="flex: 1; background-color: #f44336; color: white;">Cancel</button>
                </div>
            </div>
            <p style="font-size:12px; margin-top:10px; text-align:center; color:#999;">
                Current Rate: <span id="modal-loose-rate">0.00</span> /g
            </p>
        </div>
    </div>

    <div id="old-gold-modal" class="modal">
        <div id="old-gold-content">
            <h3>Old Jewellery Exchange</h3>
            <div id="old-gold-list"></div> <label style="margin-top:0;">Add New Item:</label>
            <div class="input-with-stepper" style="margin-top:5px;">
                 <input type="text" id="old-gold-desc" placeholder="Desc (e.g. Ring)" style="flex: 1.5; text-align: left;">
                 <input type="number" id="old-gold-value" placeholder="Value (â‚¹)" style="flex: 1;">
            </div>
            <button onclick="addOldGoldItem()" style="background-color: #4CAF50; margin-top: 10px;">Add Item</button>
            
            <div style="margin-top: 20px; font-weight: bold; text-align: right; border-top: 1px solid #ccc; padding-top: 10px;">
                Total Old Jewellery: <span id="old-gold-total-display" style="color: #f44336;">â‚¹0.00</span>
            </div>
            
            <button onclick="closeModal('old-gold-modal')" style="background-color: #555; margin-top: 10px;">Close</button>
        </div>
    </div>

    <div id="cart-modal" class="modal">
        <div id="cart-content">
            <h3>Shopping Cart</h3>
            <div id="cart-items-container">
                </div>
            <div id="cart-total-summary">
                </div>
            <div id="cart-modal-buttons">
                 <button id="close-cart-modal" onclick="closeModal('cart-modal')">Close</button>
                 <button id="clear-cart-btn" onclick="clearCart()">Clear Cart</button>
            </div>
        </div>
    </div>

    <div id="custom-modal" class="modal">
        <div id="custom-modal-content" style="max-width: 320px; text-align: center;">
            <h3 id="custom-modal-title" style="font-size: 1.25rem; margin-bottom: 10px;">Alert</h3>
            <p id="custom-modal-message" style="margin-bottom: 20px;">This is a message.</p>
            <div id="custom-modal-actions" style="display: flex; gap: 10px;">
                </div>
        </div>
    </div>


    <div id="update-rates">
        <h2>Update Stamp-Wise Rates</h2>
        <p style="font-size:14px; text-align:center; color:#666;"><em>Enter market rate per gram for purity</em></p>
      
        <label for="metal-select">Metal Type:</label>
        <select id="metal-select">
            <option value="Gold">Gold</option>
            <option value="Silver">Silver</option>
            <option value="PC">PC</option>
        </select>
      
        <label for="stamp-select">Stamp/Purity:</label>
        <select id="stamp-select"></select>
      
        <label for="price-per-gram">Price per Gram (â‚¹):</label>
        <input type="number" id="price-per-gram" placeholder="e.g., 11185" step="0.25">
      
        <button onclick="updateRate()">Update Rate</button>
      
        <div id="rates-table"></div>
        <div id="manage-stamps">
            <h4>Manage Stamps for Selected Metal</h4>
            <div class="manage-row">
                <label for="new-stamp">Add New Stamp:</label>
                <input type="text" id="new-stamp" placeholder="e.g., 20K">
                <button onclick="addStamp()">Add</button>
            </div>
            <hr>
            <div class="manage-row">
                <label for="manage-stamp">Select Stamp to Remove/Rename:</label>
                <select id="manage-stamp"></select>
                <button id="remove-stamp-btn" onclick="removeStamp()" style="background-color: #f44336; color: white;">Remove</button>
            </div>
            <div class="manage-row">
                <label for="rename-to">Rename to:</label>
                <input type="text" id="rename-to" placeholder="New name">
                <button onclick="renameStamp()">Rename</button>
            </div>
        </div>
      
        <hr>
      
        <label for="tax-percent">Global Tax (%):</label>
        <input type="number" id="tax-percent" placeholder="e.g., 3" step="0.01">
        <button onclick="updateTax()">Update Tax</button>
        
        <hr>
        
        <h3 style="text-align: center; color: #333; font-size: 16px;">Auto-Calculate from Base Rate</h3>
        <p style="font-size:12px; text-align:center; color:#666; margin-top: -10px;"><em>Set Pure Rate (e.g. 24K) and % for stamps</em></p>
        
        <label for="base-calc-metal">Metal:</label>
        <select id="base-calc-metal" onchange="renderBaseRateCalc()">
            <option value="Gold">Gold</option>
            <option value="Silver">Silver</option>
        </select>
        
        <label for="base-pure-rate">Pure Metal Rate (e.g., 24K price):</label>
        <input type="number" id="base-pure-rate" placeholder="e.g., 14300" step="0.01">
        
        <div id="base-calc-container" style="margin-top: 15px;"></div>
        
        <button onclick="applyBaseRates()" style="background-color: #2196F3; margin-top: 15px;">Apply & Update All Rates</button>
        
        <hr>
      
        <button onclick="showSection('main')">Back to Main</button>
    </div>
    <div id="excel-upload">
        <h2>Upload Excel Sheet</h2>
        <p style="font-size:14px; text-align:center; color:#666;">
            Columns: Tag No, Item Name, Size, Gr. Wt., N. Wt., Making (%), Making (per g), Making (per pc), MRP, Other Charge, Metal, Stamp
        </p>
        <div style="background-color: #e3f2fd; border: 1px solid #2196F3; color: #0d47a1; padding: 12px; margin: 10px 0; border-radius: 8px; font-size: 13px;">
            <strong>Warning:</strong> Uploading an Excel file will <u>REPLACE</u> all existing product data. Please download a backup first.
        </div>
        <input type="file" id="excel-file" accept=".xlsx, .xls" onchange="loadExcel()">
        <div id="excel-info"></div>
        <button onclick="showSection('main')">Back to Main</button>
    </div>
    <script>
        // --- PIN LOGIC ---
        const ADMIN_PIN = '9898'; 

        // --- NEW: Custom Alert/Confirm Functions ---
        const customModal = document.getElementById('custom-modal');
        const modalTitle = document.getElementById('custom-modal-title');
        const modalMessage = document.getElementById('custom-modal-message');
        const modalActions = document.getElementById('custom-modal-actions');
        let confirmCallback = null;

        function showCustomAlert(message, title = 'Alert') {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modalActions.innerHTML = `<button class="action-btn primary-btn full-width-btn" onclick="closeCustomModal()">OK</button>`;
            customModal.style.display = 'flex';
        }

        function showCustomConfirm(message, title = 'Confirm', onConfirm) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            confirmCallback = onConfirm;
            modalActions.innerHTML = `
                <button class="action-btn secondary-btn half-width-btn" onclick="closeCustomModal()">Cancel</button>
                <button class="action-btn primary-btn half-width-btn" onclick="executeConfirm()">OK</button>
            `;
            customModal.style.display = 'flex';
        }

        function executeConfirm() {
            if (typeof confirmCallback === 'function') {
                confirmCallback();
            }
            confirmCallback = null;
            closeCustomModal();
        }

        function closeCustomModal() {
            customModal.style.display = 'none';
        }

        function checkPin() {
            const input = prompt("Enter Admin PIN to proceed:"); // 'prompt' is still used for PIN entry
            if (input === ADMIN_PIN) {
                return true;
            }
            if (input !== null) { // Show alert only if user didn't cancel
                showCustomAlert("Incorrect PIN. Access denied.");
            }
            return false;
        }

        function clearAllDataWrapper() {
            closeOptions();
            if (checkPin()) {
                clearAllData();
            }
        }
        
        // NEW: Backup Function
        function downloadBackup() {
            closeOptions();
            const data = {
                rates: rates,
                taxRate: taxRate,
                products: productData,
                looseDefaults: looseDefaultsCloud,
                baseCalcDefaults: baseCalcDefaults, // NEW: Include calc defaults in backup
                backupTimestamp: new Date().toISOString()
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = "suhag_backup_" + new Date().toISOString().slice(0,10) + ".json";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // --- RESTORE FUNCTIONS (NEW) ---
        function triggerRestore() {
            closeOptions();
            if (!checkPin()) return;
            // Trigger the hidden file input
            document.getElementById('restore-file-input').click();
        }

        function processRestoreFile() {
            const fileInput = document.getElementById('restore-file-input');
            const file = fileInput.files[0];
            
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const jsonContent = JSON.parse(e.target.result);

                    if (!jsonContent.rates || !jsonContent.products) {
                        showCustomAlert("Invalid Backup File. Missing rates or products.");
                        return;
                    }

                    showCustomConfirm(
                        "WARNING: This will overwrite ALL current cloud data with the data from this backup file. Are you sure?", 
                        "Confirm Restore", 
                        () => {
                            // Use provided values or fall back to defaults if missing in JSON
                            const dataToRestore = {
                                rates: jsonContent.rates,
                                taxRate: jsonContent.taxRate || 0,
                                products: jsonContent.products || {},
                                looseDefaults: jsonContent.looseDefaults || { metal: 'Gold', stamp: '750', making: 35 },
                                baseCalcDefaults: jsonContent.baseCalcDefaults || {} // Restore new defaults
                            };

                            if (window.dbSet) {
                                window.dbSet(window.dbRef(window.firebaseDB, 'jewelryData'), dataToRestore)
                                .then(() => {
                                    showCustomAlert("Restore Successful! Reloading app...");
                                    setTimeout(() => location.reload(), 2000);
                                })
                                .catch((err) => {
                                    showCustomAlert("Restore Failed: " + err.message);
                                });
                            }
                        }
                    );
                } catch (err) {
                    showCustomAlert("Error reading file: " + err.message);
                }
                fileInput.value = ''; // Reset input
            };
            reader.readAsText(file);
        }
        // -----------------


        // Default rates structure - UPDATED PER REQUEST
        const defaultRates = {
            gold: { '916': 0, '750': 0 },        // Removed '999'
            silver: { 'S925': 0, 'S8': 0 },      // Removed '999'
            pc: { '900': 0 }                     // Removed '950' (and 999)
        };
        
        // Data variables now initialized to empty/default, filled by Firebase
        let rates = JSON.parse(JSON.stringify(defaultRates));
        let taxRate = 0;
        let productData = {};
        
        let currentProduct = null;
        let currentFinalPrice = 0;
        let currentTaxAmount = 0;
        let currentMakingAmount = 0; 
        let currentMakingType = '';
        let currentMakingInput = 0;
        let makingOverride = null;
        let looseDefaultsCloud = { metal: 'Gold', stamp: '750', making: 35 }; 
        let baseCalcDefaults = {}; // NEW: Store calc defaults
        let currentBarcode = ''; 
        let showWeightOnMain = false; // State for toggling weight display
        
        // NEW: Global cart array
        let cart = [];
        // NEW: Global for current loose calculation
        let currentLooseItem = null;
        
        // NEW: Global for Old Gold Items
        let oldGoldItems = [];

        // === FIREBASE SYNC FUNCTIONS ===
        function syncData() {
            if (!window.dbOnValue) {
                console.error("Firebase SDK  loaded correctly. Check console/network tab.");
                return;
            }
            const dataRef = window.dbRef(window.firebaseDB, 'jewelryData');
            window.dbOnValue(dataRef, (snapshot) => {
                const cloudData = snapshot.val(); 
                
                if (cloudData) {
                    rates = cloudData.rates || JSON.parse(JSON.stringify(defaultRates));
                    taxRate = cloudData.taxRate || 0;
                    productData = cloudData.products || {};
                    looseDefaultsCloud = cloudData.looseDefaults || { metal: 'Gold', stamp: '750', making: 35 };
                    baseCalcDefaults = cloudData.baseCalcDefaults || {}; // Sync defaults
                    console.log("Data synced from Firebase.");
                } else {
                    // --- CRITICAL FIX: PREVENT DATA WIPE ON LOAD ---
                    // If cloud returns null (empty or error), DO NOT SAVE defaults back to cloud.
                    // Just use defaults locally for display.
                    console.warn("No data found in cloud (or network error). Using local defaults for display. NOT overwriting cloud.");
                    
                    rates = JSON.parse(JSON.stringify(defaultRates));
                    taxRate = 0;
                    productData = {};
                    looseDefaultsCloud = { metal: 'Gold', stamp: '750', making: 35 };
                    baseCalcDefaults = {};
                    
                    // REMOVED: saveAllDataToCloud();  <-- THIS LINE WAS CAUSING THE WIPE
                }

                
                renderRatesTable(); 
                
                if (currentBarcode) {
                    runPriceCalculation(); 
                } else {
                    document.getElementById('tax-percent').value = taxRate;
                }
                populateStamps('stamp-select', document.getElementById('metal-select').value);
                populateStamps('manage-stamp', document.getElementById('metal-select').value);
                
                // NEW: Initialize the new calc renderer
                renderBaseRateCalc();

                setLooseDefaults(); 
                calculateLoosePrice(); 
            }, (error) => {
                console.error("Firebase read failed:", error);
                showCustomAlert("Error connecting to cloud database. Please check your connection.");
            });
        }

        function saveAllDataToCloud() {
            if (!window.dbSet) return;
            const dataToSave = { 
                rates: rates, 
                taxRate: taxRate, 
                products: productData,
                looseDefaults: looseDefaultsCloud,
                baseCalcDefaults: baseCalcDefaults // Save calc defaults
            };
            window.dbSet(window.dbRef(window.firebaseDB, 'jewelryData'), dataToSave)
            .then(() => {
                console.log("Data saved to Firebase successfully.");
            })
            .catch((error) => {
                console.error("Firebase write failed:", error);
                showCustomAlert("Data save failed. Check your Firebase Rules/Connection.", true);
            });
        }

        function clearAllData() {
            if (!window.dbSet) return;
            
            showCustomConfirm('Clear ALL synced data (rates, tax, products, loose defaults)? This can be undone.', 'Confirm Clear', () => {
                window.dbSet(window.dbRef(window.firebaseDB, 'jewelryData'), null)
                .then(() => {
                    showCustomAlert('All cloud data cleared. Reloading page.');
                    setTimeout(() => location.reload(), 1500);
                })
                .catch((error) => {
                    console.error("Firebase write failed:", error);
                    showCustomAlert("Data clear failed. Check console.", true);
                });
            });
        }

        // --- GENERAL UI FUNCTIONS ---
      function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            
            // If closing the cart, remove the green active styling from the button
            if (modalId === 'cart-modal') {
                const btn = document.getElementById('cart-btn-nav');
                if(btn) btn.classList.remove('active');
            }
        }

        function showSection(section) {
            document.getElementById('main-screen').style.display = 'none';
            document.getElementById('update-rates').style.display = 'none';
            document.getElementById('excel-upload').style.display = 'none';
            document.getElementById('loose-calculator').style.display = 'none';

            document.querySelectorAll('#taskbar button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Hide the Add Old Gold button unless on main screen
            const oldGoldBtn = document.getElementById('add-old-gold-btn');
            if(oldGoldBtn) oldGoldBtn.style.display = 'none';

            if (section === 'main') {
                document.getElementById('main-screen').style.display = 'flex';
                document.querySelector('#taskbar button[onclick="showSection(\'main\')"]').classList.add('active');
                if(oldGoldBtn) oldGoldBtn.style.display = 'flex'; // Show button on main
                clearAll(); 
                setTimeout(() => document.getElementById('barcode').focus(), 100);
            } else if (section === 'loose-calculator') {
                document.getElementById('loose-calculator').style.display = 'flex'; 
                document.querySelector('#taskbar button[onclick="showSection(\'loose-calculator\')"]').classList.add('active');
                setLooseDefaults(); 
                calculateLoosePrice(); 
                setTimeout(() => document.getElementById('loose-weight').focus(), 100);
            } else {
                document.getElementById(section).style.display = 'block';
            }

            if (section === 'update-rates') {
                renderRatesTable();
                const metal = document.getElementById('metal-select').value;
                populateStamps('stamp-select', metal);
                populateStamps('manage-stamp', metal);
                updateRemoveButton();
                renderBaseRateCalc(); // Refresh the calc view
            }
            closeOptions();
        }

        function toggleOptions() {
            const menu = document.getElementById('options-menu');
            menu.classList.toggle('show');
        }
        
        function closeOptions() {
            document.getElementById('options-menu').classList.remove('show');
        }
        
        document.addEventListener('click', function(e) {
            const menu = document.getElementById('options-menu');
            const btn = document.getElementById('options-btn');
            if (btn && !btn.contains(e.target) && !menu.contains(e.target)) {
                closeOptions();
            }
        });


        function renderRatesTable() {
            let html = '<h3 style="font-size:16px;margin:16px 0 8px;">Current Rates</h3><table>';
            html += '<tr><th>Metal</th><th>Stamp</th><th>â‚¹/g</th></tr>';
            for (let metal in rates) {
                for (let stamp in rates[metal]) {
                    const m = metal.charAt(0).toUpperCase() + metal.slice(1);
                    html += `<tr><td>${m}</td><td>${stamp}</td><td>${rates[metal][stamp].toFixed(2)}</td></tr>`;
                }
            }
            html += '</table><p style="margin-top:12px;"><strong>Tax:</strong> ' + taxRate + '%</p>';
            document.getElementById('rates-table').innerHTML = html;
        }

        function populateStamps(selectId, metal) {
            const select = document.getElementById(selectId);
            const lower = metal.toLowerCase();
            select.innerHTML = ''; 
            if (rates[lower]) {
                for (let stamp in rates[lower]) {
                    let opt = document.createElement('option');
                    opt.value = stamp;
                    opt.textContent = stamp;
                    
                    if (selectId.startsWith('modal-loose-stamp')) {
                        opt.dataset.rate = rates[lower][stamp];
                    }
                    select.add(opt);
                }
            }
            
            if (select.options.length === 0) {
                 select.innerHTML = '<option value="">-- No Stamps Defined --</option>';
            } else if (selectId === 'stamp-select') {
                select.prepend(new Option('-- Select --', ''));
                select.selectedIndex = 0;
            }
        }
        
        // --- NEW: AUTO-CALCULATE BASE RATES FUNCTIONS (WITH DEFAULTS) ---
        function renderBaseRateCalc() {
            const metal = document.getElementById('base-calc-metal').value.toLowerCase();
            const container = document.getElementById('base-calc-container');
            const pureRateInput = document.getElementById('base-pure-rate');
            
            container.innerHTML = '';

            if (!rates[metal]) {
                container.innerHTML = '<p style="text-align:center; color:#999;">No stamps found for this metal.</p>';
                return;
            }

            // Get defaults for this metal if they exist
            const defaults = baseCalcDefaults[metal] || {};
            const savedBaseRate = defaults.baseRate || '';
            const savedPercentages = defaults.percentages || {};

            // Pre-fill Base Rate Input
            pureRateInput.value = savedBaseRate;

            for (let stamp in rates[metal]) {
                const savedPct = savedPercentages[stamp] || '';
                
                const div = document.createElement('div');
                div.className = 'base-calc-row';
                div.innerHTML = `
                    <label>${stamp} (%):</label>
                    <input type="number" data-stamp="${stamp}" value="${savedPct}" placeholder="%" step="0.1">
                `;
                container.appendChild(div);
            }
        }

        function applyBaseRates() {
            if (!checkPin()) return;

            const metal = document.getElementById('base-calc-metal').value.toLowerCase();
            const pureRate = parseFloat(document.getElementById('base-pure-rate').value);
            const inputs = document.querySelectorAll('#base-calc-container input');

            if (isNaN(pureRate) || pureRate <= 0) {
                showCustomAlert('Please enter a valid Pure Metal Rate.');
                return;
            }
            
            // Initialize defaults object for this metal if missing
            if (!baseCalcDefaults[metal]) {
                baseCalcDefaults[metal] = { baseRate: 0, percentages: {} };
            }
            
            // Save the base rate
            baseCalcDefaults[metal].baseRate = pureRate;

            let updatedCount = 0;
            inputs.forEach(input => {
                const percentage = parseFloat(input.value);
                const stamp = input.dataset.stamp;

                if (!isNaN(percentage) && percentage > 0) {
                    // Update Rate
                    const newRate = pureRate * (percentage / 100);
                    if (rates[metal] && rates[metal][stamp] !== undefined) {
                        rates[metal][stamp] = parseFloat(newRate.toFixed(2)); // Round to 2 decimals
                        updatedCount++;
                    }
                    
                    // Save Percentage Default
                    if (!baseCalcDefaults[metal].percentages) baseCalcDefaults[metal].percentages = {};
                    baseCalcDefaults[metal].percentages[stamp] = percentage;
                }
            });

            if (updatedCount > 0) {
                saveAllDataToCloud();
                showCustomAlert(`Successfully updated ${updatedCount} rates for ${metal.charAt(0).toUpperCase() + metal.slice(1)}.\nPercentages and Base Rate saved as default.`);
                
                // Do NOT clear inputs anymore, they stay as defaults
            } else {
                showCustomAlert('No percentages were entered. No rates updated.');
            }
        }
        // ------------------------------------------------
        
        // --- LOOSE CALCULATOR FUNCTIONS ---

        function setLooseDefaults() { 
            
            const defaults = looseDefaultsCloud; 
            
            let metal = defaults.metal || 'Gold';
            let stamp = defaults.stamp || '750';
            let making = defaults.making || 35; 

            const metalKey = metal.toLowerCase();
            if (!rates[metalKey] || !rates[metalKey][stamp]) {
                if (rates[metalKey]) {
                    const availableStamps = Object.keys(rates[metalKey]);
                    if (availableStamps.length > 0) {
                        stamp = availableStamps[0];
                    } else {
                        stamp = '';
                    }
                } else {
                     metal = 'Gold';
                     const goldKey = metal.toLowerCase();
                     if (rates[goldKey]) {
                         const availableStamps = Object.keys(rates[goldKey]);
                         stamp = availableStamps.length > 0 ? availableStamps[0] : '';
                     } else {
                         stamp = '';
                     }
                }
            }
            
            document.getElementById('loose-metal-select').value = metal; 
            document.getElementById('loose-stamp-select').value = stamp; 
            document.getElementById('loose-making-percent').value = making;
        }

        // NEW: Adjust making charge by a step
        function adjustMaking(inputId, amount) {
            const input = document.getElementById(inputId);
            let currentValue = parseFloat(input.value) || 0;
            currentValue += amount;
            input.value = currentValue.toFixed(2); 
        }


        function populateModalStamps(metal) {
            const select = document.getElementById('modal-loose-stamp-select');
            const currentStamp = document.getElementById('loose-stamp-select').value;
            populateStamps('modal-loose-stamp-select', metal); 
            
            select.value = currentStamp;
            
            if(select.value !== currentStamp) {
                select.selectedIndex = 0;
            }
            updateModalRateDisplay();
        }

        function updateModalRateDisplay() {
            const select = document.getElementById('modal-loose-stamp-select');
            const rateDisplay = document.getElementById('modal-loose-rate');
            const selectedOption = select.options[select.selectedIndex];
            if (selectedOption && selectedOption.dataset.rate) {
                const rate = selectedOption.dataset.rate;
                rateDisplay.textContent = parseFloat(rate).toFixed(2);
            } else {
                rateDisplay.textContent = '0.00';
            }
        }

        function openLooseAlterDialog() {
            const metal = document.getElementById('loose-metal-select').value;
            const stamp = document.getElementById('loose-stamp-select').value;
            const making = document.getElementById('loose-making-percent').value;

            document.getElementById('modal-loose-metal-select').value = metal;
            document.getElementById('modal-loose-making-percent').value = making;
            
            populateModalStamps(metal);
            
            document.getElementById('modal-loose-stamp-select').value = stamp;
            
            updateModalRateDisplay(); 
            
            document.getElementById('modal-loose-stamp-select').onchange = updateModalRateDisplay;

            document.getElementById('loose-alter-modal').style.display = 'flex';
        }

        function closeLooseAlter() {
            closeModal('loose-alter-modal');
        }

        function updateLooseInputs() {
            const newMetal = document.getElementById('modal-loose-metal-select').value;
            const newStamp = document.getElementById('modal-loose-stamp-select').value;
            const newMaking = parseFloat(document.getElementById('modal-loose-making-percent').value);

            if (!newStamp) {
                showCustomAlert('Please select a Stamp/Purity.');
                return;
            }
            if (isNaN(newMaking) || newMaking < 0) {
                showCustomAlert('Please enter a valid Making Charge (%).');
                return;
            }

            document.getElementById('loose-metal-select').value = newMetal;
            document.getElementById('loose-stamp-select').value = newStamp;
            document.getElementById('loose-making-percent').value = newMaking;

            closeLooseAlter();
            calculateLoosePrice();
        }

        function saveLooseDefaultsToCloud() {
            if (!checkPin()) return; 

            const newMetal = document.getElementById('modal-loose-metal-select').value;
            const newStamp = document.getElementById('modal-loose-stamp-select').value;
            const newMakingRaw = document.getElementById('modal-loose-making-percent').value;
            const newMaking = parseFloat(newMakingRaw);

            if (!newStamp) {
                showCustomAlert('Please select a Stamp/Purity.');
                return;
            }
            if (isNaN(newMaking) || newMaking < 0) {
                showCustomAlert('Please enter a valid Making Charge (%).');
                return;
            }
            
            const metalKey = newMetal.toLowerCase();
            if (!rates[metalKey] || !rates[metalKey][newStamp]) {
                showCustomAlert(`Can save. The rate for ${newMetal} ${newStamp} is  set in Update Rates.`);
                return;
            }

            showCustomConfirm(`Save ${newMetal} ${newStamp} with ${newMaking.toFixed(2)}% making as the permanent default?`, 'Confirm Save', () => {
                looseDefaultsCloud = {
                    metal: newMetal,
                    stamp: newStamp,
                    making: newMaking
                };
                saveAllDataToCloud(); 
                
                document.getElementById('loose-metal-select').value = newMetal;
                document.getElementById('loose-stamp-select').value = newStamp;
                document.getElementById('loose-making-percent').value = newMaking;

                showCustomAlert('Loose defaults saved successfully. They will load automatically next time.');
                closeLooseAlter();
                calculateLoosePrice();
            });
        }
        
        function calculateLoosePrice() {
            const weightInput = document.getElementById('loose-weight');
            const priceDisplay = document.getElementById('loose-price-display');
            const metal = document.getElementById('loose-metal-select').value.toLowerCase();
            const stamp = document.getElementById('loose-stamp-select').value;
            const makingPercent = parseFloat(document.getElementById('loose-making-percent').value);
            const weight = parseFloat(weightInput.value);

            if (isNaN(weight) || weight <= 0) {
                priceDisplay.textContent = '0.00';
                currentLooseItem = null; // Clear item if invalid
                return;
            }

            const rate = rates[metal] ? rates[metal][stamp] : 0;
            if (rate === 0) {
                priceDisplay.textContent = '0.00 (No Rate)';
                currentLooseItem = null;
                return;
            }

            const metalVal = weight * rate;
            const making = metalVal * (makingPercent / 100);
            const subtotal = metalVal + making;
            const taxAmount = subtotal * (taxRate / 100);
            const finalPrice = subtotal + taxAmount;

            priceDisplay.textContent = finalPrice.toFixed(2);
            
            // NEW: Populate the current loose item for cart addition
            currentLooseItem = {
                type: 'loose', // Important flag
                id: Date.now() + Math.random(),
                itemName: `Loose ${metal.charAt(0).toUpperCase() + metal.slice(1)} ${stamp}`,
                weight: weight,
                finalPrice: finalPrice
            };
        }

        function clearLooseScreen() {
            document.getElementById('loose-weight').value = '';
            document.getElementById('loose-price-display').textContent = '0.00';
            document.getElementById('loose-weight').focus();
            currentLooseItem = null; // Clear stored item
        }

        // NEW: Add to Cart for Loose Items
        function addToCartLoose() {
            if (!currentLooseItem || currentLooseItem.finalPrice <= 0) {
                showCustomAlert('Please enter a valid weight to calculate price first.');
                return;
            }

            cart.push(currentLooseItem);
            localStorage.setItem('suhagPriceCheckerCart', JSON.stringify(cart));
            updateCartIcon();
            showCustomAlert(`${currentLooseItem.itemName} added to cart!`);
            
            clearLooseScreen();
        }

        function addRepairToCart() {
            const amount = parseFloat(document.getElementById('repair-amount').value);
            if (isNaN(amount) || amount <= 0) {
                showCustomAlert('Please enter a valid amount.');
                return;
            }
            const item = {
                type: 'repair',
                id: Date.now() + Math.random(),
                itemName: 'Other ',
                finalPrice: amount
            };
            cart.push(item);
            localStorage.setItem('suhagPriceCheckerCart', JSON.stringify(cart));
            updateCartIcon();
            showCustomAlert('Other added to cart!');
            document.getElementById('repair-amount').value = '';
        }
        
        // --- END LOOSE CALCULATION FUNCTIONS ---

        // --- PRODUCT PRICE CALCULATION AND ALTER FUNCTIONS ---

        function runPriceCalculation() {
            // Reset display state (but  the product code info text yet)
            document.getElementById('price-display').textContent = '0.00';
            document.getElementById('price-display').classList.remove('show');
            document.getElementById('detail-btn').style.display = 'none';
            document.getElementById('add-to-cart-btn').style.display = 'none';
            document.getElementById('alter-btn').style.display = 'none';
            document.getElementById('clear-screen-btn').style.display = 'none';
            
            // New logic to reset weight toggle on new scan
            showWeightOnMain = false; 
            
            if (!currentBarcode) {
                 document.getElementById('product-code').textContent = ''; // Clear if no barcode
                 return; 
            }
            
            if (!productData[currentBarcode]) {
                document.getElementById('product-code').textContent = `Barcode: ${currentBarcode} -  found`;
                document.getElementById('clear-screen-btn').style.display = 'block';
                return;
            }

            currentProduct = productData[currentBarcode];
            const d = currentProduct;
            let final = 0, making = 0, otherCharge = d.otherCharge || 0;
            currentTaxAmount = 0;
            const weight = d.netWeight;
            
            // Initial update of product info display (Name/Barcode)
            updateMainDisplayInfo();

            if (d.mrp > 0) {
                let total = d.mrp + otherCharge;
                currentTaxAmount = total * (taxRate / 100);
                final = total + currentTaxAmount;
            } else {
                const mKey = d.metal, stamp = d.stamp;
                if (!mKey || !stamp || !rates[mKey] || rates[mKey][stamp] === undefined || rates[mKey][stamp] === 0) {
                    document.getElementById('product-code').textContent = `Barcode: ${currentBarcode} - Rates missing or zero for ${d.metal} ${d.stamp}`;
                    document.getElementById('clear-screen-btn').style.display = 'block';
                    return;
                }
                const rate = rates[mKey][stamp];
                const metalVal = weight * rate;
                
                if (makingOverride) {
                    if (makingOverride.type === '%') {
                        making = metalVal * (makingOverride.input / 100);
                    } else if (makingOverride.type === 'per g') {
                        making = makingOverride.input * weight;
                    } else { // per pc
                        making = makingOverride.input;
                    }
                    currentMakingType = makingOverride.type;
                    currentMakingInput = makingOverride.input;
                } else if (d.makingPerPc > 0) {
                    making = d.makingPerPc;
                    currentMakingType = 'per pc';
                    currentMakingInput = d.makingPerPc;
                } else if (d.makingPerGram > 0) {
                    making = d.makingPerGram * weight;
                    currentMakingType = 'per g';
                    currentMakingInput = d.makingPerGram;
                } else if (d.makingPercent > 0) {
                    making = metalVal * (d.makingPercent / 100);
                    currentMakingType = '%';
                    currentMakingInput = d.makingPercent;
                } else {
                    currentMakingType = '';
                }
                
                let total = metalVal + making + otherCharge;
                currentTaxAmount = total * (taxRate / 100);
                final = total + currentTaxAmount;
                currentMakingAmount = making;

                if (currentMakingType !== '') {
                    document.getElementById('alter-btn').style.display = 'block'; 
                }
            }

            currentFinalPrice = final;
            document.getElementById('price-display').textContent = `${final.toFixed(2)}`;
            document.getElementById('price-display').classList.add('show');
            document.getElementById('detail-btn').style.display = 'block'; 
            document.getElementById('add-to-cart-btn').style.display = 'block'; 
            document.getElementById('clear-screen-btn').style.display = 'block'; 
        }

        // NEW: Function to toggle product info display
        function toggleProductInfo() {
            if (!currentProduct) return;
            showWeightOnMain = !showWeightOnMain;
            updateMainDisplayInfo();
        }

        // NEW: Function to update the product info text based on state
        function updateMainDisplayInfo() {
            const el = document.getElementById('product-code');
            if (!currentProduct) {
                 // If called when no product is active, ensure it's empty or shows error
                 return;
            }

            if (showWeightOnMain) {
                 // MODIFIED: Added Size display logic here
                 let sizeStr = currentProduct.size ? `Size: ${currentProduct.size} | ` : '';
                 el.textContent = `${sizeStr}Gr: ${currentProduct.grossWeight}g | Nt: ${currentProduct.netWeight}g`;
                 el.style.fontWeight = 'bold'; // Optional: make weight stand out
            } else {
                 el.textContent = `Barcode: ${currentBarcode} | Product: ${currentProduct.itemName || 'Unknown'}`;
                 el.style.fontWeight = 'normal';
            }
        }

        function lookupProduct(barcode) {
            makingOverride = null; 
            currentBarcode = barcode;
            runPriceCalculation();
        }

        function updateMaking() {
            const newInput = parseFloat(document.getElementById('new-making').value);
            if (isNaN(newInput) || newInput < 0) {
                showCustomAlert('Enter a valid positive number.');
                return;
            }
            makingOverride = { 
                type: currentMakingType, 
                input: newInput 
            };
            
            runPriceCalculation(); 
            
            closeModal('alter-modal');
        }

        function openAlterDialog() {
            if (!currentProduct || currentMakingType === '') {
                showCustomAlert('No making charge to alter.');
                return;
            }

            let currentInput = currentMakingInput;
            let currentType = currentMakingType;

            if (makingOverride) {
                currentInput = makingOverride.input;
                currentType = makingOverride.type;
            }

            const html = `<p><strong>Current:</strong> ${currentInput.toFixed(2)} ${currentType}</p>`;
            document.getElementById('alter-body').innerHTML = html;
            document.getElementById('new-making').placeholder = `Enter new value (in ${currentType})`;
            document.getElementById('new-making').value = currentInput;
            document.getElementById('alter-modal').style.display = 'flex';
            document.getElementById('new-making').focus();
        }

        function showDetails() {
            if (!currentProduct) return;
            const d = currentProduct;
            // MODIFIED: Added Size to details view
            let html = `
                <p><strong>Item Name:</strong> <span>${d.itemName || ''}</span></p>
                <p><strong>Barcode:</strong> <span>${currentBarcode}</span></p>
                <p><strong>Size:</strong> <span>${d.size || '-'}</span></p>
                <p><strong>Gr. Wt.:</strong> <span>${d.grossWeight.toFixed(2)}g</span></p>
                <p><strong>N. Wt.:</strong> <span>${d.netWeight.toFixed(2)}g</span></p>
                <p><strong>Other Charge:</strong> <span>${(d.otherCharge || 0).toFixed(2)}</span></p>
            `;
            if (d.mrp > 0) {
                html += `
                    <p><strong>Type:</strong> <span>Fixed Rate</span></p>
                    <p><strong>Rate:</strong> <span>${d.mrp.toFixed(2)}</span></p>
                    <hr>
                    <p><strong>Tax (${taxRate}%):</strong> <span>${currentTaxAmount.toFixed(2)}</span></p>
                    <p><strong>Final Amount:</strong> <span>${currentFinalPrice.toFixed(2)}</span></p>
                `;
            } else {
                const mKey = d.metal, stamp = d.stamp;
                const rate = rates[mKey] && rates[mKey][stamp] !== undefined ? rates[mKey][stamp] : 0;
                let makingStr = '0';
                let makingInput = currentMakingInput;
                let activeMakingType = currentMakingType; 

                if (makingOverride) {
                    makingInput = makingOverride.input;
                    activeMakingType = makingOverride.type;
                }

                if (activeMakingType === '%') {
                    makingStr = `${makingInput}%`;
                } else if (activeMakingType === 'per g') {
                    makingStr = `${makingInput.toFixed(2)} (per g)`;
                } else if (activeMakingType === 'per pc') {
                    makingStr = `${makingInput.toFixed(2)} (per pc)`;
                }
                
                let infoButtonHtml = '';
                if (currentMakingAmount > 0 && currentMakingAmount < 1500) {
                    infoButtonHtml = `
                        <button onclick="showCustomAlert('Making Charge Amount: â‚¹' + currentMakingAmount.toFixed(2))" 
                                style="width: 20px; height: 20px; border-radius: 50%; border: 1px solid #999; background: #eee; color: #333; font-size: 14px; font-weight: bold; font-style: normal; padding: 0; line-height: 19px; text-align: center; cursor: pointer; margin-right: 8px; vertical-align: middle;">
                            i
                        </button>
                    `;
                }

                html += `
                    <p><strong>Metal:</strong> <span>${mKey.charAt(0).toUpperCase() + mKey.slice(1)}</span></p>
                    <p><strong>Stamp:</strong> <span>${stamp}</span></p>
                    <p><strong>Making:</strong> 
                        <span>
                            ${infoButtonHtml}
                            ${makingStr}
                        </span>
                    </p>
                    <p><strong>Rate/g:</strong> <span>${rate.toFixed(2)}</span></p>
                    <hr>
                    <p><strong>Tax (${taxRate}%):</strong> <span>${currentTaxAmount.toFixed(2)}</span></p>
                    <p><strong>Final Amount:</strong> <span>${currentFinalPrice.toFixed(2)}</span></p>
                `;
            }
            document.getElementById('detail-body').innerHTML = html;
            document.getElementById('detail-modal').style.display = 'flex';
        }

        function closeDetails() {
            document.getElementById('detail-modal').style.display = 'none';
        }
        
        // --- CART FUNCTIONS ---
        
        function updateCartIcon() {
            const count = cart.length;
            const counterNav = document.getElementById('cart-counter-nav');
            const counterMain = document.getElementById('cart-counter');

            counterNav.textContent = count;
            counterMain.textContent = count;

            if (count > 0) {
                counterNav.style.display = 'block';
                counterMain.style.display = 'block';
                document.getElementById('cart-btn').style.display = 'block'; // Show main cart button if items exist
            } else {
                counterNav.style.display = 'none';
                counterMain.style.display = 'none';
                document.getElementById('cart-btn').style.display = 'none'; // Hide main cart button if empty
            }
        }

        function addToCart() {
            if (!currentProduct || currentFinalPrice <= 0) {
                showCustomAlert('Can add to cart. No valid product found or price is zero.');
                return;
            }

            const item = {
                id: Date.now() + Math.random(), // Unique ID
                barcode: currentBarcode,
                itemName: currentProduct.itemName || 'Unknown Item',
                finalPrice: currentFinalPrice,
                makingOverride: makingOverride // NEW: Save the override state
            };

            cart.push(item);
            localStorage.setItem('suhagPriceCheckerCart', JSON.stringify(cart)); // Save cart
            updateCartIcon();
            showCustomAlert(`${item.itemName} added to cart!`);
            
            clearAll(); 
        }

        function openCart() {
            // Add active class to make button green
            const btn = document.getElementById('cart-btn-nav');
            if(btn) btn.classList.add('active');
            
            const modal = document.getElementById('cart-modal');
            const cartItemsDiv = document.getElementById('cart-items-container');
            const cartTotalSummaryDiv = document.getElementById('cart-total-summary');

            // --- REFACTORED CART LOGIC START ---
            let cartTotal = 0;
            let cartHtml = '';
            
            if (cart.length === 0) {
                cartItemsDiv.innerHTML = '<p class="empty-cart-message">Cart is empty.</p>';
            } else {
                cart.forEach(item => {
                    cartTotal += item.finalPrice;
                    
                    let details = '';
                    let clickAction = '';
                    
                    // Loose Jewellery Logic
                    if (item.type === 'loose') {
                        details = `Weight: ${item.weight.toFixed(2)}g`;
                        clickAction = ''; 
                    } else if (item.type === 'repair') {
                        details = '';
                        clickAction = '';
                    } else {
                        // Standard Logic
                        const overrideData = JSON.stringify(item.makingOverride);
                        details = `Barcode: ${item.barcode}`;
                        clickAction = `onclick='viewItemFromCart("${item.barcode}", ${overrideData})'`;
                    }

                    cartHtml += `
                        <div class="cart-item">
                            <div class="cart-item-details" ${clickAction} ${item.type === 'loose' || item.type === 'repair' ? 'style="cursor: default;"' : ''}>
                                <div class="cart-item-title">${item.itemName}</div>
                                <div class="cart-item-barcode">${details}</div>
                            </div>
                            <span class="cart-item-price">â‚¹${item.finalPrice.toFixed(2)}</span>
                            <button class="remove-item-btn" onclick="removeFromCart(${item.id})">&times;</button>
                        </div>
                    `;
                });
                cartItemsDiv.innerHTML = cartHtml;
            }

            // Calculate Old Gold
            let oldGoldTotal = 0;
            oldGoldItems.forEach(item => oldGoldTotal += item.value);

            let netPayable = cartTotal - oldGoldTotal;
            
            // Generate Summary HTML
            let summaryHtml = `
                <div style="display:flex; justify-content:space-between;">
                    <span>Cart Total:</span><span>â‚¹${cartTotal.toFixed(2)}</span>
                </div>
            `;
            
            if (oldGoldTotal > 0) {
                summaryHtml += `
                    <div style="display:flex; justify-content:space-between; color: #f44336;">
                        <span>Less Old jewellery:</span><span>- â‚¹${oldGoldTotal.toFixed(2)}</span>
                    </div>
                    <div style="display:flex; justify-content:space-between; font-size: 1.1em; font-weight: bold; border-top: 1px dashed #ccc; padding-top: 5px; margin-top: 5px;">
                        <span>Net Payable:</span><span>â‚¹${netPayable.toFixed(2)}</span>
                    </div>
                `;
            } else {
                 // Standard display if no old gold
                 summaryHtml = `
                    <div style="display:flex; justify-content:space-between; font-size: 1.3em;">
                        <span>Total:</span><span>â‚¹${cartTotal.toFixed(2)}</span>
                    </div>
                 `;
            }
            
            cartTotalSummaryDiv.innerHTML = summaryHtml;
            // --- REFACTORED CART LOGIC END ---

            modal.style.display = 'flex';
        }

        function removeFromCart(itemId) {
            showCustomConfirm('Are you sure you want to remove this item from the cart?', 'Confirm Removal', () => {
                cart = cart.filter(item => item.id !== itemId);
                localStorage.setItem('suhagPriceCheckerCart', JSON.stringify(cart));
                updateCartIcon();
                openCart(); // Re-render the cart modal
            });
        }

        // NEW: Function to view item and restore its specific making charge
        function viewItemFromCart(barcode, overrideData) {
            closeModal('cart-modal');
            // Set the making override *before* looking up the product
            makingOverride = overrideData; 
            document.getElementById('barcode').value = barcode;
            lookupProduct(barcode); // This will use the makingOverride
        }

        // NEW: Clear Cart Function
        function clearCart() {
            if (cart.length === 0) {
                showCustomAlert('Cart is already empty.');
                return;
            }
            showCustomConfirm('Are you sure you want to clear the entire cart? This can be undone.', 'Confirm Clear Cart', () => {
                cart = [];
                localStorage.setItem('suhagPriceCheckerCart', JSON.stringify(cart));
                updateCartIcon();
                openCart(); // Re-render the empty cart modal
                showCustomAlert('Cart cleared successfully.');
            });
        }
        // --- END CART FUNCTIONS ---
        
        // --- OLD GOLD FUNCTIONS ---
        function openOldGoldModal() {
            renderOldGoldList();
            document.getElementById('old-gold-modal').style.display = 'flex';
        }
        
        function addOldGoldItem() {
            const desc = document.getElementById('old-gold-desc').value.trim() || 'Old Jewellery';
            const val = parseFloat(document.getElementById('old-gold-value').value);
            
            if(!val || val <= 0) {
                showCustomAlert("Please enter a valid value.");
                return;
            }
            
            oldGoldItems.push({ desc: desc, value: val, id: Date.now() });
            localStorage.setItem('suhagPriceCheckerOldGold', JSON.stringify(oldGoldItems));
            
            // Clear inputs
            document.getElementById('old-gold-desc').value = '';
            document.getElementById('old-gold-value').value = '';
            
            renderOldGoldList();
            showCustomAlert("Item added successfully!");
        }

        function removeOldGoldItem(id) {
             oldGoldItems = oldGoldItems.filter(i => i.id !== id);
             localStorage.setItem('suhagPriceCheckerOldGold', JSON.stringify(oldGoldItems));
             renderOldGoldList();
        }

        function renderOldGoldList() {
            const list = document.getElementById('old-gold-list');
            list.innerHTML = '';
            let total = 0;
            
            if (oldGoldItems.length === 0) {
                list.innerHTML = '<p style="text-align:center; color:#999;">No old jewellery added.</p>';
            } else {
                oldGoldItems.forEach(item => {
                    total += item.value;
                    list.innerHTML += `
                        <div class="old-gold-item-row">
                            <span>${item.desc}</span>
                            <span style="font-weight:bold; color: #f44336;">- â‚¹${item.value.toFixed(2)}</span>
                            <button onclick="removeOldGoldItem(${item.id})" class="remove-old-gold-btn">&times;</button>
                        </div>
                    `;
                });
            }
            document.getElementById('old-gold-total-display').textContent = 'â‚¹' + total.toFixed(2);
        }
        // --------------------------

        // --- UTILITY/SETUP FUNCTIONS ---
        
        function clearAll() {
            document.getElementById('barcode').value = '';
            document.getElementById('product-code').textContent = '';
            document.getElementById('price-display').textContent = '0.00';
            document.getElementById('price-display').classList.remove('show');
            document.getElementById('detail-btn').style.display = 'none';
            document.getElementById('add-to-cart-btn').style.display = 'none'; 
            document.getElementById('alter-btn').style.display = 'none';
            document.getElementById('clear-screen-btn').style.display = 'none';
            makingOverride = null;
            currentMakingType = '';
            currentMakingInput = 0;
            currentBarcode = '';
            document.getElementById('barcode').focus();
            closeOptions();
            updateCartIcon(); // Show cart button if items are in cart
        }

        function updateRemoveButton() {
            const stamp = document.getElementById('manage-stamp').value;
            const btn = document.getElementById('remove-stamp-btn');
            if (btn) {
                btn.disabled = !stamp || stamp === '-- No Stamps Defined --';
            }
        }
        function addStamp() {
            if (!checkPin()) return; 
            const metal = document.getElementById('metal-select').value.toLowerCase();
            const newStamp = document.getElementById('new-stamp').value.trim().toUpperCase();
            if (!metal || !newStamp) {
                showCustomAlert('Please select metal and enter stamp name.');
                return;
            }
            if (!rates[metal]) {
                rates[metal] = {};
            }
            if (rates[metal][newStamp]) {
                showCustomAlert('Stamp already exists.');
                return;
            }
            rates[metal][newStamp] = 0;
            saveAllDataToCloud(); 
            document.getElementById('new-stamp').value = '';
            showCustomAlert(`Added ${newStamp} for ${metal}`);
        }
        function removeStamp() {
            if (!checkPin()) return; 
            const metal = document.getElementById('metal-select').value.toLowerCase();
            const stamp = document.getElementById('manage-stamp').value;
            if (!stamp || stamp === '-- No Stamps Defined --') {
                showCustomAlert('Please select a stamp to remove.');
                return;
            }
            showCustomConfirm(`Remove ${stamp} for ${metal.toUpperCase()}?`, 'Confirm Removal', () => {
                delete rates[metal][stamp];
                saveAllDataToCloud(); 
                showCustomAlert(`Removed ${stamp}`);
            });
        }
        function renameStamp() {
            if (!checkPin()) return; 
            const metal = document.getElementById('metal-select').value.toLowerCase();
            const oldStamp = document.getElementById('manage-stamp').value;
            const newName = document.getElementById('rename-to').value.trim().toUpperCase();
            if (!oldStamp || oldStamp === '-- No Stamps Defined --') {
                showCustomAlert('Please select a stamp to rename.');
                return;
            }
            if (!newName || newName === oldStamp) {
                showCustomAlert('Please enter a different new name.');
                return;
            }
            if (rates[metal][newName]) {
                showCustomAlert('New name already exists.');
                return;
            }
            rates[metal][newName] = rates[metal][oldStamp];
            delete rates[metal][oldStamp];
            saveAllDataToCloud(); 
            document.getElementById('rename-to').value = '';
            showCustomAlert(`Renamed ${oldStamp} to ${newName}`);
        }
        function loadExcel() {
            if (!checkPin()) { 
                document.getElementById('excel-file').value = ''; 
                return; 
            }
            const fileInput = document.getElementById('excel-file');
            const file = fileInput.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                const json = XLSX.utils.sheet_to_json(sheet, {header: 1});
                const headers = (json[0] || []).map(h => (h || '').toString().trim().toLowerCase());
                const cols = {
                    tagNo: findColumn(headers, ['tag no', 'tagno', 'barcode']),
                    itemName: findColumn(headers, ['item name', 'name', 'product name', 'item']),
                    // MODIFIED: Added Size column search
                    size: findColumn(headers, ['size', 'ring size', 'bangle size', 'measure']),
                    grossWeight: findColumn(headers, ['gr. wt.', 'gr wt', 'gross weight', 'gross wt', 'grossweight']),
                    netWeight: findColumn(headers, ['n. wt.', 'n wt', 'net weight', 'net wt', 'netweight']),
                    makingPct: findColumn(headers, ['making (%)', 'making%', 'making percent']),
                    mGram: findColumn(headers, ['making (per g)', 'making per g', 'making/g', 'mc/g']),
                    mPc: findColumn(headers, ['making (per pc)', 'making per pc', 'making/pc', 'mc/pc']),
                    mrp: findColumn(headers, ['mrp', 'price', 'selling price', 'final price']),
                    otherCharge: findColumn(headers, ['other charge', 'other', 'extra charge']),
                    metal: findColumn(headers, ['metal']),
                    stamp: findColumn(headers, ['stamp'])
                };
                if (cols.tagNo === -1) {
                    document.getElementById('excel-info').innerHTML = '<p style="color:red;">Error: Tag No column required</p>';
                    return;
                }
                let count = 0;
                let newProductData = {}; 
                for (let i = 1; i < json.length; i++) {
                    const row = json[i];
                    const tagNo = (row[cols.tagNo] || '').toString().trim().toUpperCase();
                    if (!tagNo) continue;
                    const grossWt = cols.grossWeight !== -1 ? parseFloat(row[cols.grossWeight]) || 0 : 0;
                    const netWt = cols.netWeight !== -1 ? parseFloat(row[cols.netWeight]) || 0 : grossWt;
                    newProductData[tagNo] = {
                        itemName: cols.itemName !== -1 ? (row[cols.itemName] || '').toString().trim() : '',
                        // MODIFIED: Added Size storage logic
                        size: cols.size !== -1 ? (row[cols.size] || '').toString().trim() : '',
                        grossWeight: grossWt,
                        netWeight: netWt,
                        makingPercent: cols.makingPct !== -1 ? parseFloat(row[cols.makingPct]) || 0 : 0,
                        makingPerGram: cols.mGram !== -1 ? parseFloat(row[cols.mGram]) || 0 : 0,
                        makingPerPc: cols.mPc !== -1 ? parseFloat(row[cols.mPc]) || 0 : 0,
                        mrp: cols.mrp !== -1 ? parseFloat(row[cols.mrp]) || 0 : 0,
                        otherCharge: cols.otherCharge !== -1 ? parseFloat(row[cols.otherCharge]) || 0 : 0,
                        metal: cols.metal !== -1 ? (row[cols.metal] || '').toString().trim().toLowerCase() : '',
                        stamp: cols.stamp !== -1 ? (row[cols.stamp] || '').toString().trim().toUpperCase() : ''
                    };
                    count++;
                }
                
                // --- SAFETY CONFIRMATION BEFORE OVERWRITE ---
                const currentCount = Object.keys(productData).length;
                showCustomConfirm(
                    `This will REPLACE your entire product list (${currentCount} items) with ${count} new items from Excel. Proceed?`, 
                    'Confirm Replacement', 
                    () => {
                        productData = newProductData; // Replaces everything as requested
                        saveAllDataToCloud(); 
                        document.getElementById('excel-info').innerHTML = `<p>Successfully loaded ${count} products.</p>`;
                    }
                );
                // Clear input if canceled or done so onchange fires again if same file selected
                if (!confirmCallback) fileInput.value = ''; 
            };
            reader.readAsArrayBuffer(file);
        }
        function findColumn(headers, names) {
            for (let i = 0; i < headers.length; i++) {
                for (let name of names) {
                    if (headers[i] === name.toLowerCase()) return i;
                }
            }
            return -1;
        }

        function updateRate() {
            if (!checkPin()) return; 
            const metal = document.getElementById('metal-select').value.toLowerCase();
            const stamp = document.getElementById('stamp-select').value;
            const price = parseFloat(document.getElementById('price-per-gram').value);
            if (rates[metal] && rates[metal][stamp] !== undefined && !isNaN(price)) {
                rates[metal][stamp] = price;
                saveAllDataToCloud(); 
                showCustomAlert(`Updated: ${metal} ${stamp} â†’ â‚¹${price}/g`);
                document.getElementById('price-per-gram').value = '';
            } else {
                showCustomAlert('Invalid input');
            }
        }
        function updateTax() {
            if (!checkPin()) return; 
            const tax = parseFloat(document.getElementById('tax-percent').value);
            if (!isNaN(tax)) {
                taxRate = tax;
                saveAllDataToCloud(); 
                showCustomAlert(`Tax updated to ${tax}%`);
                document.getElementById('tax-percent').value = tax;
            } else {
                showCustomAlert('Invalid tax');
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            const metalSelect = document.getElementById('metal-select');
            metalSelect.addEventListener('change', () => {
                const value = metalSelect.value;
                populateStamps('stamp-select', value);
                populateStamps('manage-stamp', value);
                updateRemoveButton();
            });

            populateStamps('stamp-select', 'Gold');
            populateStamps('manage-stamp', 'Gold');
            updateRemoveButton();
            document.getElementById('manage-stamp').addEventListener('change', updateRemoveButton);

            showSection('main');

            const barcodeInput = document.getElementById('barcode');
            
            // --- Global keydown listener for seamless scanning ---
            document.addEventListener('keydown', function(event) {
                if (document.getElementById('main-screen').style.display !== 'flex') {
                    return;
                }
                if (document.activeElement === barcodeInput) {
                    return; 
                }
                if (event.key.length === 1 && !event.ctrlKey && !event.metaKey && !event.altKey) {
                    const activeTag = document.activeElement.tagName.toLowerCase();
                    if (activeTag === 'input' || activeTag === 'textarea' || activeTag === 'select') {
                        return;
                    }
                    barcodeInput.focus();
                }
            });

            // --- "Enter" key listener ---
            barcodeInput.addEventListener('keydown', function(event) {
                if (event.key === 'Enter') { 
                    event.preventDefault();
                    const barcode = barcodeInput.value.trim().toUpperCase();
                    barcodeInput.value = ''; 
                    barcodeInput.focus(); 
                    lookupProduct(barcode); 
                }
            });
            
            // --- Load Cart from Local Storage ---
            try {
                const savedCart = localStorage.getItem('suhagPriceCheckerCart');
                if (savedCart) {
                    cart = JSON.parse(savedCart);
                }
            } catch (e) {
                console.error("Failed to load cart from localStorage", e);
                cart = [];
            }
            
            // --- Load Old Gold from Local Storage ---
            try {
                const savedOldGold = localStorage.getItem('suhagPriceCheckerOldGold');
                if (savedOldGold) {
                    oldGoldItems = JSON.parse(savedOldGold);
                }
            } catch (e) {
                console.error("Failed to load old gold from localStorage", e);
                oldGoldItems = [];
            }
            
            updateCartIcon(); // Update counter on load

            // --- Start Firebase Sync ---
            syncData();
        });
        
        // --- Expose functions to global scope for HTML onclick ---
        window.showSection = showSection;
        window.toggleOptions = toggleOptions;
        window.closeOptions = closeOptions;
        window.lookupProduct = lookupProduct;
        window.clearAll = clearAll;
        window.showDetails = showDetails;
        window.closeModal = closeModal;
        window.openAlterDialog = openAlterDialog;
        window.updateMaking = updateMaking;
        window.clearLooseScreen = clearLooseScreen;
        window.openLooseAlterDialog = openLooseAlterDialog;
        window.calculateLoosePrice = calculateLoosePrice;
        window.closeLooseAlter = closeLooseAlter;
        window.updateLooseInputs = updateLooseInputs;
        window.saveLooseDefaultsToCloud = saveLooseDefaultsToCloud;
        window.populateModalStamps = populateModalStamps;
        window.updateRate = updateRate;
        window.updateTax = updateTax;
        window.addStamp = addStamp;
        window.removeStamp = removeStamp;
        window.renameStamp = renameStamp;
        window.loadExcel = loadExcel;
        window.clearAllDataWrapper = clearAllDataWrapper;
        window.openCart = openCart;
        window.closeCart = closeCart;
        window.addToCart = addToCart;
        window.removeFromCart = removeFromCart;
        window.viewItemFromCart = viewItemFromCart;
        window.executeConfirm = executeConfirm;
        window.closeCustomModal = closeCustomModal;
        window.adjustMaking = adjustMaking; 
        window.toggleProductInfo = toggleProductInfo;
        window.clearCart = clearCart;
        window.downloadBackup = downloadBackup; // Backup
        window.triggerRestore = triggerRestore; // Restore (New)
        window.processRestoreFile = processRestoreFile; // Restore Logic (New)
        window.addToCartLoose = addToCartLoose; // Loose Add Cart (New)
        window.addRepairToCart = addRepairToCart;
        
        // Old Gold Functions
        window.openOldGoldModal = openOldGoldModal;
        window.addOldGoldItem = addOldGoldItem;
        window.removeOldGoldItem = removeOldGoldItem;
        
        // Auto Calc Functions
        window.renderBaseRateCalc = renderBaseRateCalc;
        window.applyBaseRates = applyBaseRates;

    </script>
</body>
</html>
