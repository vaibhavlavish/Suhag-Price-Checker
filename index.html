<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Suhag Price Checker</title>

    <link rel="manifest" href="manifest.json">

    <meta name="theme-color" content="#1a1a1a">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SuhagPrice">
    <link rel="apple-touch-icon" href="icon-192.png">

    <script type="module">
        // Import the functions you need from the Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
          apiKey: "AIzaSyDaRjbdCnfx5-C4OXQaByZMxK2r0Cu19bI",
          authDomain: "suhag-f53e4.firebaseapp.com",
          databaseURL: "https://suhag-f53e4-default-rtdb.asia-southeast1.firebasedatabase.app",
          projectId: "suhag-f53e4",
          storageBucket: "suhag-f53e4.firebasestorage.app",
          messagingSenderId: "231258063675",
          appId: "1:231258063675:web:1c79c2a0d4d5796a6d2d1e",
          measurementId: "G-MJ1BBWZFVW"
        };


        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // Expose Firebase functions to the global scope for the main script
        window.firebaseDB = db;
        window.dbRef = ref;
        window.dbSet = set;
        window.dbOnValue = onValue;
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            touch-action: manipulation;
        }
        #taskbar {
            background-color: #1a1a1a;
            color: white;
            padding: 8px 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: nowrap;
            gap: 4px;
            -webkit-overflow-scrolling: touch;
            position: relative;
        }
        #taskbar button {
            background-color: #333;
            color: white;
            border: none;
            padding: 10px 16px;
            margin: 0;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            white-space: nowrap;
            flex: 1;
            max-width: 120px;
        }
        #taskbar button:hover {
            background-color: #555;
        }
        #taskbar button.active {
            background-color: #4CAF50;
        }
        #options-btn {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            padding: 8px 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #options-menu {
            display: none;
            position: absolute;
            top: 100%;
            right: 12px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.2);
            overflow: hidden;
            z-index: 1000;
            min-width: 180px;
            margin-top: 4px;
        }
        #options-menu.show {
            display: block;
            animation: fadeIn 0.2s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-8px); }
            to { opacity: 1; transform: translateY(0); }
        }
        #options-menu button {
            display: block;
            width: 100%;
            background: none;
            border: none;
            padding: 14px 16px;
            text-align: left;
            font-size: 15px;
            color: #333;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }
        #options-menu button:last-child {
            border-bottom: none;
        }
        #options-menu button.danger {
            color: #d32f2f;
        }
        #options-menu button.danger:hover {
            background-color: #ffebee;
        }
        #main-screen {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px 15px;
            background-color: #f5f5f5;
            overflow-y: auto;
            min-height: calc(100vh - 60px);
        }
        #loose-calculator {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px 15px;
            background-color: #f5f5f5;
            overflow-y: auto;
            min-height: calc(100vh - 60px);
            width: 100%;
            max-width: 420px;
            margin: 0 auto;
        }
        #barcode, #loose-weight { /* Added loose-weight here for styling */
            font-size: 20px;
            padding: 16px;
            width: 100%;
            max-width: 100%;
            text-align: center;
            border: 2px solid #ddd;
            border-radius: 10px;
            margin-bottom: 16px;
            background: white;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }
        #barcode:focus, #loose-weight:focus {
            border-color: #4CAF50;
            outline: none;
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.2);
        }
        #product-code {
            font-size: 16px;
            color: #555;
            margin: 8px 0;
            text-align: center;
            width: 100%;
            word-wrap: break-word;
        }
        #price-display {
            font-size: 48px;
            font-weight: 700;
            color: #4CAF50;
            margin: 8px 0;
            opacity: 0;
            transition: opacity 0.4s ease;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        #loose-price-display { /* Style for loose calculator display */
            font-size: 48px;
            font-weight: 700;
            color: #4CAF50;
            margin: 20px 0;
            text-align: center;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        #price-display.show {
            opacity: 1;
        }
        #detail-btn, #alter-btn, .clear-btn {
            margin: 8px 4px 0;
            padding: 12px 28px;
            font-size: 16px;
            font-weight: 600;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            display: none;
            box-shadow: 0 3px 8px;
            transition: all 0.2s;
        }
        #detail-btn {
            background-color: #2196F3;
            box-shadow: 0 3px 8px rgba(33, 150, 243, 0.3);
        }
        #alter-btn {
            background-color: #FF9800;
            box-shadow: 0 3px 8px rgba(255, 152, 0, 0.3);
        }
        .clear-btn {
            background-color: #f44336;
            box-shadow: 0 3px 8px rgba(244, 67, 54, 0.3);
        }
        #detail-btn:active, #alter-btn:active, .clear-btn:active {
            transform: translateY(1px);
            box-shadow: 0 1px 4px;
        }
        /* Reused Modal Styles */
        #detail-modal, #alter-modal, #loose-alter-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.75);
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 15px;
        }
        #detail-content, #alter-content, #loose-alter-content {
            background: white;
            padding: 20px;
            border-radius: 16px;
            max-width: 380px;
            width: 100%;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            max-height: 90vh;
            overflow-y: auto;
        }
        #detail-content h3, #alter-content h3, #loose-alter-content h3 {
            margin: 0 0 16px 0;
            color: #333;
            font-size: 20px;
            text-align: center;
            border-bottom: 1px solid #eee;
            padding-bottom: 12px;
        }
        #detail-content p {
            margin: 10px 0;
            font-size: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center; /* Ensures button aligns nicely */
            padding: 6px 0;
            border-bottom: 1px dashed #eee;
        }
        #detail-content p:last-of-type {
            border-bottom: none;
            font-weight: 600;
            font-size: 16px;
            color: #4CAF50;
        }
        #detail-content p strong {
            color: #333;
            min-width: 120px;
        }
        #close-modal {
            background-color: #f44336;
            color: white;
            border: none;
            padding: 10px 20px;
            margin-top: 16px;
            border-radius: 25px;
            cursor: pointer;
            width: 100%;
            font-size: 16px;
            font-weight: 600;
            box-shadow: 0 3px 8px rgba(244, 67, 54, 0.3);
        }
        #close-modal:active {
            transform: translateY(1px);
        }
        #alter-body p {
            margin: 10px 0;
            font-size: 15px;
            text-align: center;
            color: #666;
        }
        #new-making {
            margin: 16px 0;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            width: 100%;
            font-size: 16px;
        }
        #new-making:focus {
            border-color: #4CAF50;
            outline: none;
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
        }
        #alter-buttons {
            display: flex;
            gap: 10px;
            margin-top: 16px;
        }
        #alter-buttons button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            color: white;
            box-shadow: 0 3px 8px;
            transition: all 0.2s;
        }
        #update-making-btn {
            background-color: #4CAF50;
            box-shadow: 0 3px 8px rgba(76, 175, 80, 0.3);
        }
        #cancel-making-btn {
            background-color: #f44336;
            box-shadow: 0 3px 8px rgba(244, 67, 54, 0.3);
        }
        #alter-buttons button:active {
            transform: translateY(1px);
            box-shadow: 0 1px 4px;
        }
        /* Hidden sections - includes the new loose calculator */
        #update-rates, #excel-upload { 
            display: none;
            max-width: 100%;
            margin: 0;
            background: white;
            padding: 20px 15px;
            border-radius: 0;
            box-shadow: none;
            flex: 1;
            overflow-y: auto;
        }
        #update-rates h2, #excel-upload h2, #loose-calculator h2 {
            color: #333;
            font-size: 18px;
            margin-top: 0;
            text-align: center;
        }
        input, select, button, #excel-file {
            margin: 8px 0;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            width: 100%;
            font-size: 16px;
        }
        input:focus, select:focus {
            border-color: #4CAF50;
            outline: none;
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
        }
        button:not(#taskbar button):not(#detail-btn):not(#alter-btn):not(#close-modal):not(#options-btn) {
            background-color: #4CAF50;
            color: white;
            cursor: pointer;
            font-weight: 600;
            box-shadow: 0 3px 8px rgba(76, 175, 80, 0.3);
            margin: 4px 0;
            width: auto;
            padding: 10px 16px;
        }
        button:not(#taskbar button):not(#detail-btn):not(#alter-btn):not(#close-modal):not(#options-btn):active {
            transform: translateY(1px);
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        #manage-stamps {
            margin-top: 20px;
            padding: 16px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #f9f9f9;
        }
        #manage-stamps h4 {
            margin: 0 0 12px 0;
            color: #333;
            font-size: 16px;
        }
        #manage-stamps hr {
            border: none;
            border-top: 1px solid #ccc;
        }
        .manage-row {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: end;
            margin-bottom: 12px;
        }
        .manage-row label {
            min-width: 140px;
            margin: 0;
        }
        .manage-row input, .manage-row select {
            flex: 1;
            min-width: 120px;
        }
        .manage-row button {
            flex-shrink: 0;
            width: auto;
            padding: 8px 12px;
            font-size: 14px;
        }
        #excel-info {
            background-color: #fff8e1;
            border: 1px solid #ffe082;
            color: #5d4037;
            padding: 12px;
            margin: 12px 0;
            border-radius: 8px;
            font-size: 14px;
        }
        label {
            display: block;
            margin: 12px 0 4px 0;
            font-weight: 600;
            font-size: 14px;
            color: #333;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 16px;
            font-size: 14px;
        }
        th, td {
            padding: 10px 8px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #333;
        }
        hr {
            border: none;
            border-top: 1px solid #eee;
            margin: 20px 0;
        }
        /* Responsive adjustments */
        @media (min-width: 480px) {
            #taskbar {
                padding: 10px 16px;
            }
            #taskbar button {
                font-size: 15px;
                padding: 12px 18px;
            }
            #barcode, #loose-weight {
                font-size: 22px;
                padding: 18px;
            }
            #price-display, #loose-price-display {
                font-size: 56px;
            }
            #detail-content, #alter-content, #loose-alter-content {
                max-width: 420px;
            }
            .manage-row {
                flex-wrap: nowrap;
            }
        }
    </style>
</head>
<body>
    <div id="taskbar">
        <button onclick="showSection('main')" class="active">Main</button>
        <button onclick="showSection('loose-calculator')">Loose</button>
        <button id="options-btn" onclick="toggleOptions()">More</button>
        <div id="options-menu">
            <button onclick="showSection('update-rates')">Update Rates</button>
            <button onclick="showSection('excel-upload')">Upload Excel</button>
            <button onclick="clearAll()">Clear Screen</button>
            <button onclick="clearAllDataWrapper()" class="danger">Clear All Data (Cloud)</button>
        </div>
    </div>
    <div id="main-screen">
        <input type="text" id="barcode" placeholder="Scan or enter barcode..." autofocus>
        <div id="product-code"></div>
        <h1 id="price-display">0.00</h1>
        <div style="display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
            <button onclick="clearAll()" class="clear-btn" id="clear-screen-btn">Clear Screen</button>
            <button id="detail-btn" onclick="showDetails()">View Details</button>
            <button id="alter-btn" onclick="openAlterDialog()">Alter</button>
        </div>
    </div>
    <div id="loose-calculator">
        <h2 style="display: none;">Loose Jewellery Price Calculator</h2>
        
        <input type="hidden" id="loose-metal-select" value="Gold">
        <input type="hidden" id="loose-stamp-select" value="750">
        <input type="hidden" id="loose-making-percent" value="35">
        
        <label for="loose-weight">Weight (Grams):</label>
        <input type="number" id="loose-weight" placeholder="Enter weight in grams" step="0.01" oninput="calculateLoosePrice()">
        
        <hr style="display: none;">

        <p style="text-align: center; font-size: 18px; font-weight: 600; color: #333;">Final Price:</p>
        <h1 id="loose-price-display">0.00</h1>

        <div id="loose-details" style="display: none;"></div>
        
        <button id="loose-clear-btn" onclick="clearLooseScreen()" 
            style="margin-top: 20px; background-color: #f44336; color: white; padding: 10px 20px; border-radius: 25px; font-weight: 600; box-shadow: 0 3px 8px rgba(244, 67, 54, 0.3);">
            Clear Screen
        </button>

        <button id="loose-alter-btn" onclick="openLooseAlterDialog()" 
            style="margin-top: 10px; background-color: #FF9800; color: white; padding: 10px 20px; border-radius: 25px; font-weight: 600; box-shadow: 0 3px 8px rgba(255, 152, 0, 0.3);">
            Alter
        </button>

        <button onclick="showSection('main')" style="margin-top: 10px;">Back to Main</button>
    </div>
    <div id="detail-modal">
        <div id="detail-content">
            <h3>Product Details</h3>
            <div id="detail-body"></div>
            <button id="close-modal" onclick="closeDetails()">Close</button>
        </div>
    </div>
    <div id="alter-modal">
        <div id="alter-content">
            <h3>Alter Making Charge</h3>
            <div id="alter-body"></div>
            <label for="new-making">New Making Charge (same unit):</label>
            <input type="number" id="new-making" step="0.01">
            <div id="alter-buttons">
                <button id="update-making-btn" onclick="updateMaking()">Update</button>
                <button id="cancel-making-btn" onclick="closeAlter()">Cancel</button>
            </div>
        </div>
    </div>
    
    <div id="loose-alter-modal">
        <div id="loose-alter-content">
            <h3>Loose Calculation Settings</h3>
            <div id="loose-alter-body">
                <label for="modal-loose-metal-select">Metal Type:</label>
                <select id="modal-loose-metal-select" onchange="populateModalStamps(this.value)">
                    <option value="Gold">Gold</option>
                    <option value="Silver">Silver</option>
                    <option value="PC">PC</option>
                </select>

                <label for="modal-loose-stamp-select">Stamp/Purity:</label>
                <select id="modal-loose-stamp-select"></select>

                <label for="modal-loose-making-percent">Making Charge (%):</label>
                <input type="number" id="modal-loose-making-percent" placeholder="e.g., 35" step="0.01">
            </div>
            <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 16px;">
                <button id="save-loose-defaults-btn" onclick="saveLooseDefaultsToCloud()" 
                    style="background-color: #2196F3; color: white; padding: 12px; border-radius: 25px; font-weight: 600; border: none; box-shadow: 0 3px 8px rgba(33, 150, 243, 0.3); width: 100%;">
                    Save Current As Default
                </button>
                <div id="modal-buttons" style="display: flex; gap: 10px;">
                    <button id="update-loose-inputs-btn" onclick="updateLooseInputs()" style="flex: 1; background-color: #4CAF50; color: white;">Apply Changes</button>
                    <button id="cancel-loose-btn" onclick="closeLooseAlter()" style="flex: 1; background-color: #f44336; color: white;">Cancel</button>
                </div>
            </div>
            <p style="font-size:12px; margin-top:10px; text-align:center; color:#999;">
                Current Rate: <span id="modal-loose-rate">0.00</span> /g
            </p>
        </div>
    </div>
    <div id="update-rates">
        <h2>Update Stamp-Wise Rates</h2>
        <p style="font-size:14px; text-align:center; color:#666;"><em>Enter market rate per gram for purity</em></p>
      
        <label for="metal-select">Metal Type:</label>
        <select id="metal-select">
            <option value="Gold">Gold</option>
            <option value="Silver">Silver</option>
            <option value="PC">PC</option>
        </select>
      
        <label for="stamp-select">Stamp/Purity:</label>
        <select id="stamp-select"></select>
      
        <label for="price-per-gram">Price per Gram (₹):</label>
        <input type="number" id="price-per-gram" placeholder="e.g., 11185" step="0.01">
      
        <button onclick="updateRate()">Update Rate</button>
      
        <div id="rates-table"></div>
        <div id="manage-stamps">
            <h4>Manage Stamps for Selected Metal</h4>
            <div class="manage-row">
                <label for="new-stamp">Add New Stamp:</label>
                <input type="text" id="new-stamp" placeholder="e.g., 20K">
                <button onclick="addStamp()">Add</button>
            </div>
            <hr>
            <div class="manage-row">
                <label for="manage-stamp">Select Stamp to Remove/Rename:</label>
                <select id="manage-stamp"></select>
                <button id="remove-stamp-btn" onclick="removeStamp()" style="background-color: #f44336; color: white;">Remove</button>
            </div>
            <div class="manage-row">
                <label for="rename-to">Rename to:</label>
                <input type="text" id="rename-to" placeholder="New name">
                <button onclick="renameStamp()">Rename</button>
            </div>
        </div>
      
        <hr>
      
        <label for="tax-percent">Global Tax (%):</label>
        <input type="number" id="tax-percent" placeholder="e.g., 3" step="0.01">
        <button onclick="updateTax()">Update Tax</button>
      
        <button onclick="showSection('main')">Back to Main</button>
    </div>
    <div id="excel-upload">
        <h2>Upload Excel Sheet</h2>
        <p style="font-size:14px; text-align:center; color:#666;">
            Columns: Tag No, Item Name, Gr. Wt., N. Wt., Making (%), Making (per g), Making (per pc), MRP, Other Charge, Metal, Stamp
        </p>
        <input type="file" id="excel-file" accept=".xlsx, .xls" onchange="loadExcel()">
        <div id="excel-info"></div>
        <button onclick="showSection('main')">Back to Main</button>
    </div>
    <script>
        // --- PIN LOGIC ---
        const ADMIN_PIN = '9898'; // Change this PIN to your desired password!

        function checkPin() {
            const input = prompt("Enter Admin PIN to proceed:");
            if (input === ADMIN_PIN) {
                return true;
            }
            alert("Incorrect PIN. Access denied.");
            return false;
        }

        function clearAllDataWrapper() {
            closeOptions();
            if (checkPin()) {
                clearAllData();
            }
        }
        // -----------------


        // Default rates structure
        const defaultRates = {
            gold: { '999': 0, '916': 0, '750': 0 },
            silver: { '999': 0, 'S925': 0, 'S8': 0 },
            pc: { '950': 0, '900': 0 }
        };
        // Data variables now initialized to empty/default, filled by Firebase
        let rates = JSON.parse(JSON.stringify(defaultRates));
        let taxRate = 0;
        let productData = {};
        
        let currentProduct = null;
        let currentFinalPrice = 0;
        let currentTaxAmount = 0;
        let currentMakingAmount = 0; // <-- NEW: Global var for making charge
        let currentMakingType = '';
        let currentMakingInput = 0;
        let makingOverride = null;
        // NEW: Global variable for cloud-synced loose defaults
        let looseDefaultsCloud = { metal: 'Gold', stamp: '750', making: 35 }; 
        let currentBarcode = ''; 

        // === FIREBASE SYNC FUNCTIONS ===
        function syncData() {
            if (!window.dbOnValue) {
                console.error("Firebase SDK not loaded correctly. Check console/network tab.");
                return;
            }
            const dataRef = window.dbRef(window.firebaseDB, 'jewelryData');
            window.dbOnValue(dataRef, (snapshot) => {
                const cloudData = snapshot.val(); // Use .val() directly
                
                if (cloudData) {
                    // Data exists, use it
                    rates = cloudData.rates || JSON.parse(JSON.stringify(defaultRates));
                    taxRate = cloudData.taxRate || 0;
                    productData = cloudData.products || {};
                    looseDefaultsCloud = cloudData.looseDefaults || { metal: 'Gold', stamp: '750', making: 35 };
                } else {
                    // Data does not exist (first run/cleared), initialize and save
                    rates = JSON.parse(JSON.stringify(defaultRates));
                    taxRate = 0;
                    productData = {};
                    looseDefaultsCloud = { metal: 'Gold', stamp: '750', making: 35 };
                    // Save to establish the structure in Firebase for the first time
                    saveAllDataToCloud(); 
                }

                console.log("Data synced from Firebase.");
                
                // CRITICAL: Re-render UI elements that rely on initial load
                renderRatesTable(); 
                
                // Since data can change at any time, re-lookup the current barcode
                if (currentBarcode) {
                    // FIXED: Call the new core logic function
                    runPriceCalculation(); 
                } else {
                    // Update tax input field on rate update
                    document.getElementById('tax-percent').value = taxRate;
                }
                populateStamps('stamp-select', document.getElementById('metal-select').value);
                populateStamps('manage-stamp', document.getElementById('metal-select').value);

                // Update the loose calculator configuration after rates sync
                setLooseDefaults(); // This will load the synced defaults
                calculateLoosePrice(); // Recalculate loose price with potentially new rates
            }, (error) => {
                console.error("Firebase read failed:", error);
                alert("Error connecting to cloud database. Please check your connection.");
            });
        }

        function saveAllDataToCloud() {
            if (!window.dbSet) return;
            const dataToSave = { 
                rates: rates, 
                taxRate: taxRate, 
                products: productData,
                // NEW: Include loose defaults in the save
                looseDefaults: looseDefaultsCloud
            };
            window.dbSet(window.dbRef(window.firebaseDB, 'jewelryData'), dataToSave)
            .then(() => {
                console.log("Data saved to Firebase successfully.");
            })
            .catch((error) => {
                console.error("Firebase write failed:", error);
                alert("Data save failed. Check your Firebase Rules/Connection.");
            });
        }

        function clearAllData() {
            if (!window.dbSet) return;
            // PIN is checked in clearAllDataWrapper()
            if (confirm('Clear ALL synced data (rates, tax, products, loose defaults)? This cannot be undone.')) {
                // Clear the whole jewelryData node
                window.dbSet(window.dbRef(window.firebaseDB, 'jewelryData'), null)
                .then(() => {
                    alert('All data cleared from the cloud. Reloading page.');
                    location.reload();
                })
                .catch((error) => {
                    console.error("Firebase write failed:", error);
                    alert("Data clear failed. Check your Firebase Rules/Connection.");
                });
            }
        }

        // --- GENERAL UI FUNCTIONS ---
        function closeOptions() {
            document.getElementById('options-menu').classList.remove('show');
        }

        function showSection(section) {
            // Hide all main sections
            document.getElementById('main-screen').style.display = 'none';
            document.getElementById('update-rates').style.display = 'none';
            document.getElementById('excel-upload').style.display = 'none';
            document.getElementById('loose-calculator').style.display = 'none';

            // Remove active class from all taskbar buttons
            document.querySelectorAll('#taskbar button').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show the requested section and set button active class
            if (section === 'main') {
                document.getElementById('main-screen').style.display = 'flex';
                document.querySelector('#taskbar button[onclick="showSection(\'main\')"]').classList.add('active');
                clearAll(); // Clear main screen on return
                setTimeout(() => document.getElementById('barcode').focus(), 100);
            } else if (section === 'loose-calculator') {
                document.getElementById('loose-calculator').style.display = 'flex'; // Changed to flex for centering
                document.querySelector('#taskbar button[onclick="showSection(\'loose-calculator\')"]').classList.add('active');
                // 1. Ensure stamps and defaults are set
                setLooseDefaults(); 
                // 2. Calculate price with defaults and current weight
                calculateLoosePrice(); 
                setTimeout(() => document.getElementById('loose-weight').focus(), 100);
            } else {
                document.getElementById(section).style.display = 'block';
            }

            if (section === 'update-rates') {
                renderRatesTable();
                const metal = document.getElementById('metal-select').value;
                populateStamps('stamp-select', metal);
                populateStamps('manage-stamp', metal);
                updateRemoveButton();
            }
            closeOptions();
        }

        function toggleOptions() {
            const menu = document.getElementById('options-menu');
            menu.classList.toggle('show');
        }
        
        // Close menu when clicking outside
        document.addEventListener('click', function(e) {
            const menu = document.getElementById('options-menu');
            const btn = document.getElementById('options-btn');
            if (!btn.contains(e.target) && !menu.contains(e.target)) {
                closeOptions();
            }
        });


        function renderRatesTable() {
            let html = '<h3 style="font-size:16px;margin:16px 0 8px;">Current Rates</h3><table>';
            html += '<tr><th>Metal</th><th>Stamp</th><th>₹/g</th></tr>';
            for (let metal in rates) {
                for (let stamp in rates[metal]) {
                    const m = metal.charAt(0).toUpperCase() + metal.slice(1);
                    html += `<tr><td>${m}</td><td>${stamp}</td><td>${rates[metal][stamp].toFixed(2)}</td></tr>`;
                }
            }
            html += '</table><p style="margin-top:12px;"><strong>Tax:</strong> ' + taxRate + '%</p>';
            document.getElementById('rates-table').innerHTML = html;
        }

        function populateStamps(selectId, metal) {
            const select = document.getElementById(selectId);
            const lower = metal.toLowerCase();
            select.innerHTML = ''; // Clear previous options
            if (rates[lower]) {
                for (let stamp in rates[lower]) {
                    let opt = document.createElement('option');
                    opt.value = stamp;
                    opt.textContent = stamp;
                    
                    // For modal: add data-rate for display
                    if (selectId.startsWith('modal-loose-stamp')) {
                        opt.dataset.rate = rates[lower][stamp];
                    }
                    select.add(opt);
                }
            }
            // Add a default selection if needed
            if (select.options.length === 0) {
                 select.innerHTML = '<option value="">-- No Stamps Defined --</option>';
            } else if (selectId === 'stamp-select') {
                select.prepend(new Option('-- Select --', ''));
                select.selectedIndex = 0;
            }
        }
        
        // --- LOOSE CALCULATOR FUNCTIONS ---

        // MODIFIED: Reads from global looseDefaultsCloud synced from Cloud
        function setLooseDefaults() { 
            
            const defaults = looseDefaultsCloud; 
            
            let metal = defaults.metal || 'Gold';
            let stamp = defaults.stamp || '750';
            let making = defaults.making || 35; // Your code said 35, I'll use that.

            // Safety check: Ensure the stamp is valid for the selected metal
            const metalKey = metal.toLowerCase();
            if (!rates[metalKey] || !rates[metalKey][stamp]) {
                // If the saved stamp is no longer available, fall back to the first available one
                if (rates[metalKey]) {
                    const availableStamps = Object.keys(rates[metalKey]);
                    if (availableStamps.length > 0) {
                        stamp = availableStamps[0];
                    } else {
                        stamp = ''; // No stamp available for this metal
                    }
                } else {
                     // If the metal itself is invalid, fall back to 'Gold'
                     metal = 'Gold';
                     const goldKey = metal.toLowerCase();
                     if (rates[goldKey]) {
                         const availableStamps = Object.keys(rates[goldKey]);
                         stamp = availableStamps.length > 0 ? availableStamps[0] : '';
                     } else {
                         stamp = '';
                     }
                }
            }
            
            // Update the hidden inputs (which hold the session's active loose config)
            document.getElementById('loose-metal-select').value = metal; 
            document.getElementById('loose-stamp-select').value = stamp; 
            document.getElementById('loose-making-percent').value = making;
        }


        // NEW: Populates the stamp select in the Loose Alter Modal
        function populateModalStamps(metal) {
            const select = document.getElementById('modal-loose-stamp-select');
            const currentStamp = document.getElementById('loose-stamp-select').value;
            populateStamps('modal-loose-stamp-select', metal); // Use the generic populate function
            
            // Try to re-select the current stamp if the metal matches
            select.value = currentStamp;
            
            // If the stamp doesn't exist for the new metal, select the first one
            if(select.value !== currentStamp) {
                select.selectedIndex = 0;
            }
            updateModalRateDisplay();
        }

        // NEW: Updates the rate display in the Loose Alter Modal
        function updateModalRateDisplay() {
            const select = document.getElementById('modal-loose-stamp-select');
            const rateDisplay = document.getElementById('modal-loose-rate');
            const selectedOption = select.options[select.selectedIndex];
            if (selectedOption && selectedOption.dataset.rate) {
                const rate = selectedOption.dataset.rate;
                rateDisplay.textContent = parseFloat(rate).toFixed(2);
            } else {
                rateDisplay.textContent = '0.00';
            }
        }

        // NEW: Opens the Loose Alter Modal
        function openLooseAlterDialog() {
            // Read current values from hidden inputs (source of truth)
            const metal = document.getElementById('loose-metal-select').value;
            const stamp = document.getElementById('loose-stamp-select').value;
            const making = document.getElementById('loose-making-percent').value;

            // Populate modal inputs
            document.getElementById('modal-loose-metal-select').value = metal;
            document.getElementById('modal-loose-making-percent').value = making;
            
            // Populate stamps based on metal
            populateModalStamps(metal);
            
            // Set the correct stamp selection in the modal
            document.getElementById('modal-loose-stamp-select').value = stamp;
            
            // Update rate display in the modal
            updateModalRateDisplay(); 
            
            // Add listener to the stamp select in the modal for dynamic rate update
            document.getElementById('modal-loose-stamp-select').onchange = updateModalRateDisplay;

            document.getElementById('loose-alter-modal').style.display = 'flex';
        }

        // NEW: Closes the Loose Alter Modal
        function closeLooseAlter() {
            document.getElementById('loose-alter-modal').style.display = 'none';
        }

        // NEW: Applies the settings from the Loose Alter Modal (for current session only)
        function updateLooseInputs() {
            const newMetal = document.getElementById('modal-loose-metal-select').value;
            const newStamp = document.getElementById('modal-loose-stamp-select').value;
            const newMaking = parseFloat(document.getElementById('modal-loose-making-percent').value);

            if (!newStamp) {
                alert('Please select a Stamp/Purity.');
                return;
            }
            if (isNaN(newMaking) || newMaking < 0) {
                alert('Please enter a valid Making Charge (%).');
                return;
            }

            // Update the hidden inputs (Source of truth for the session)
            document.getElementById('loose-metal-select').value = newMetal;
            document.getElementById('loose-stamp-select').value = newStamp;
            document.getElementById('loose-making-percent').value = newMaking;

            closeLooseAlter();
            calculateLoosePrice();
        }

        // NEW: Saves the current settings in the Loose Alter Modal as the new default to the cloud
        function saveLooseDefaultsToCloud() {
            if (!checkPin()) return; // Require PIN check to save defaults

            const newMetal = document.getElementById('modal-loose-metal-select').value;
            const newStamp = document.getElementById('modal-loose-stamp-select').value;
            const newMakingRaw = document.getElementById('modal-loose-making-percent').value;
            const newMaking = parseFloat(newMakingRaw);

            if (!newStamp) {
                alert('Please select a Stamp/Purity.');
                return;
            }
            if (isNaN(newMaking) || newMaking < 0) {
                alert('Please enter a valid Making Charge (%).');
                return;
            }
            
            // Check if the stamp is valid for the metal before saving
            const metalKey = newMetal.toLowerCase();
            if (!rates[metalKey] || !rates[metalKey][newStamp]) {
                alert(`Cannot save. The rate for ${newMetal} ${newStamp} is not set in Update Rates.`);
                return;
            }

            if (confirm(`Save ${newMetal} ${newStamp} with ${newMaking.toFixed(2)}% making as the permanent default? This will be used every time the app starts.`)) {
                // 1. Update the cloud defaults variable
                looseDefaultsCloud = {
                    metal: newMetal,
                    stamp: newStamp,
                    making: newMaking
                };

                // 2. Save the whole data structure to the cloud
                saveAllDataToCloud(); // This function now includes looseDefaultsCloud
                
                // 3. Update the active calculation inputs for the current session and recalculate
                document.getElementById('loose-metal-select').value = newMetal;
                document.getElementById('loose-stamp-select').value = newStamp;
                document.getElementById('loose-making-percent').value = newMaking;

                alert('Loose defaults saved successfully. They will load automatically next time.');
                closeLooseAlter();
                calculateLoosePrice();
            }
        }
        
        // Loose Price Calculation
        function calculateLoosePrice() {
            const weightInput = document.getElementById('loose-weight');
            const priceDisplay = document.getElementById('loose-price-display');
            const metal = document.getElementById('loose-metal-select').value.toLowerCase();
            const stamp = document.getElementById('loose-stamp-select').value;
            const makingPercent = parseFloat(document.getElementById('loose-making-percent').value);
            const weight = parseFloat(weightInput.value);

            if (isNaN(weight) || weight <= 0) {
                priceDisplay.textContent = '0.00';
                return;
            }

            const rate = rates[metal] ? rates[metal][stamp] : 0;
            if (rate === 0) {
                priceDisplay.textContent = '0.00 (No Rate)';
                return;
            }

            const metalVal = weight * rate;
            const making = metalVal * (makingPercent / 100);
            const subtotal = metalVal + making;
            const taxAmount = subtotal * (taxRate / 100);
            const finalPrice = subtotal + taxAmount;

            priceDisplay.textContent = finalPrice.toFixed(2);
        }

        function clearLooseScreen() {
            document.getElementById('loose-weight').value = '';
            document.getElementById('loose-price-display').textContent = '0.00';
            document.getElementById('loose-weight').focus();
        }
        
        // --- END LOOSE CALCULATION FUNCTIONS ---

        // --- PRODUCT PRICE CALCULATION AND ALTER FUNCTIONS ---

        // FIXED: This function is the core logic, called by lookupProduct and updateMaking
        function runPriceCalculation() {
            // Clear display elements
            document.getElementById('product-code').textContent = '';
            document.getElementById('price-display').textContent = '0.00';
            document.getElementById('price-display').classList.remove('show');
            document.getElementById('detail-btn').style.display = 'none';
            document.getElementById('alter-btn').style.display = 'none';
            document.getElementById('clear-screen-btn').style.display = 'none';
            
            if (!currentBarcode) return; // Exit if no barcode
            
            if (!productData[currentBarcode]) {
                document.getElementById('product-code').textContent = `Barcode: ${currentBarcode} - Not found`;
                document.getElementById('clear-screen-btn').style.display = 'inline-block';
                return;
            }

            currentProduct = productData[currentBarcode];
            const d = currentProduct;
            let final = 0, making = 0, otherCharge = d.otherCharge || 0;
            currentTaxAmount = 0;
            const weight = d.netWeight;
            
            // --- Price Calculation Logic ---
            if (d.mrp > 0) {
                let total = d.mrp + otherCharge;
                currentTaxAmount = total * (taxRate / 100);
                final = total + currentTaxAmount;
            } else {
                const mKey = d.metal, stamp = d.stamp;
                if (!mKey || !stamp || !rates[mKey] || rates[mKey][stamp] === undefined || rates[mKey][stamp] === 0) {
                    document.getElementById('product-code').textContent = `Barcode: ${currentBarcode} - Rates missing or zero for ${d.metal} ${d.stamp}`;
                    document.getElementById('clear-screen-btn').style.display = 'inline-block';
                    return;
                }
                const rate = rates[mKey][stamp];
                const metalVal = weight * rate;
                
                // Determine Making Charge and Type
                // Check for override first
                if (makingOverride) {
                    if (makingOverride.type === '%') {
                        making = metalVal * (makingOverride.input / 100);
                    } else if (makingOverride.type === 'per g') {
                        making = makingOverride.input * weight;
                    } else { // per pc
                        making = makingOverride.input;
                    }
                    currentMakingType = makingOverride.type;
                    currentMakingInput = makingOverride.input;
                } else if (d.makingPerPc > 0) {
                    making = d.makingPerPc;
                    currentMakingType = 'per pc';
                    currentMakingInput = d.makingPerPc;
                } else if (d.makingPerGram > 0) {
                    making = d.makingPerGram * weight;
                    currentMakingType = 'per g';
                    currentMakingInput = d.makingPerGram;
                } else if (d.makingPercent > 0) {
                    making = metalVal * (d.makingPercent / 100);
                    currentMakingType = '%';
                    currentMakingInput = d.makingPercent;
                } else {
                    currentMakingType = '';
                }
                
                let total = metalVal + making + otherCharge;
                currentTaxAmount = total * (taxRate / 100);
                final = total + currentTaxAmount;

                // NEW: Store calculated making amount
                currentMakingAmount = making;

                if (currentMakingType !== '') {
                    document.getElementById('alter-btn').style.display = 'inline-block';
                }
            }
            // --- End Price Calculation Logic ---

            currentFinalPrice = final;
            document.getElementById('product-code').textContent = `Barcode: ${currentBarcode} | Product: ${d.itemName || 'Unknown'}`;
            document.getElementById('price-display').textContent = `${final.toFixed(2)}`;
            document.getElementById('price-display').classList.add('show');
            document.getElementById('detail-btn').style.display = 'inline-block';
            document.getElementById('clear-screen-btn').style.display = 'inline-block';
        }

        // FIXED: This function is for NEW scans/inputs. It resets the override.
        // It is now only called by the "Enter" key listener.
        function lookupProduct(barcode) {
            makingOverride = null; // Reset on any new scan
            currentBarcode = barcode;
            // Call the core logic
            runPriceCalculation();
        }

        // FIXED: This function applies the override, then calls the core logic WITHOUT resetting.
        function updateMaking() {
            const newInput = parseFloat(document.getElementById('new-making').value);
            if (isNaN(newInput) || newInput < 0) {
                alert('Enter a valid positive number.');
                return;
            }
            // Set the override
            makingOverride = { 
                type: currentMakingType, 
                input: newInput 
            };
            
            // Recalculate price with the override
            runPriceCalculation(); 
            
            closeAlter();
        }

        function closeAlter() {
            document.getElementById('alter-modal').style.display = 'none';
        }

        function openAlterDialog() {
            if (!currentProduct || currentMakingType === '') {
                alert('No making charge to alter.');
                return;
            }

            // Determine what to show in the modal based on any existing override
            let currentInput = currentMakingInput;
            let currentType = currentMakingType;

            if (makingOverride) {
                currentInput = makingOverride.input;
                currentType = makingOverride.type;
            }

            const html = `<p><strong>Current:</strong> ${currentInput.toFixed(2)} ${currentType}</p>`;
            document.getElementById('alter-body').innerHTML = html;
            document.getElementById('new-making').placeholder = `Enter new value (in ${currentType})`;
            document.getElementById('new-making').value = '';
            document.getElementById('alter-modal').style.display = 'flex';
            document.getElementById('new-making').focus();
        }

        function showDetails() {
            if (!currentProduct) return;
            const d = currentProduct;
            let html = `
                <p><strong>Item Name:</strong> <span>${d.itemName || ''}</span></p>
                <p><strong>Barcode:</strong> <span>${currentBarcode}</span></p>
                <p><strong>Gr. Wt.:</strong> <span>${d.grossWeight.toFixed(2)}g</span></p>
                <p><strong>N. Wt.:</strong> <span>${d.netWeight.toFixed(2)}g</span></p>
                <p><strong>Other Charge:</strong> <span>${(d.otherCharge || 0).toFixed(2)}</span></p>
            `;
            if (d.mrp > 0) {
                html += `
                    <p><strong>Type:</strong> <span>Fixed MRP</span></p>
                    <p><strong>MRP:</strong> <span>${d.mrp.toFixed(2)}</span></p>
                    <hr>
                    <p><strong>Tax (${taxRate}%):</strong> <span>${currentTaxAmount.toFixed(2)}</span></p>
                    <p><strong>Final Amount:</strong> <span>${currentFinalPrice.toFixed(2)}</span></p>
                `;
            } else {
                const mKey = d.metal, stamp = d.stamp;
                const rate = rates[mKey] && rates[mKey][stamp] !== undefined ? rates[mKey][stamp] : 0;
                let makingStr = '0';
                let makingInput = currentMakingInput;
                let activeMakingType = currentMakingType; // Use the one determined by lookup

                if (makingOverride) {
                    makingInput = makingOverride.input;
                    activeMakingType = makingOverride.type;
                }

                if (activeMakingType === '%') {
                    makingStr = `${makingInput}%`;
                } else if (activeMakingType === 'per g') {
                    makingStr = `${makingInput.toFixed(2)} (per g)`;
                } else if (activeMakingType === 'per pc') {
                    makingStr = `${makingInput.toFixed(2)} (per pc)`;
                }
                
                // MODIFIED: Conditionally show the 'i' button only if making charge is below 1500
                let infoButtonHtml = '';
                if (currentMakingAmount > 0 && currentMakingAmount < 1500) {
                    infoButtonHtml = `
                        <button onclick="alert('Making Charge Amount: ₹' + currentMakingAmount.toFixed(2))" 
                                style="width: 20px; height: 20px; border-radius: 50%; border: 1px solid #999; background: #eee; color: #333; font-size: 14px; font-weight: bold; font-style: normal; padding: 0; line-height: 19px; text-align: center; cursor: pointer; margin-right: 8px; vertical-align: middle;">
                            i
                        </button>
                    `;
                }

                html += `
                    <p><strong>Metal:</strong> <span>${mKey.charAt(0).toUpperCase() + mKey.slice(1)}</span></p>
                    <p><strong>Stamp:</strong> <span>${stamp}</span></p>
                    <p><strong>Making:</strong> 
                        <span>
                            ${infoButtonHtml}
                            ${makingStr}
                        </span>
                    </p>
                    <p><strong>Rate/g:</strong> <span>${rate.toFixed(2)}</span></p>
                    <hr>
                    <p><strong>Tax (${taxRate}%):</strong> <span>${currentTaxAmount.toFixed(2)}</span></p>
                    <p><strong>Final Amount:</strong> <span>${currentFinalPrice.toFixed(2)}</span></p>
                `;
            }
            document.getElementById('detail-body').innerHTML = html;
            document.getElementById('detail-modal').style.display = 'flex';
        }

        function closeDetails() {
            document.getElementById('detail-modal').style.display = 'none';
        }
        
        // --- UTILITY/SETUP FUNCTIONS ---
        
        function clearAll() {
            document.getElementById('barcode').value = '';
            document.getElementById('product-code').textContent = '';
            document.getElementById('price-display').textContent = '0.00';
            document.getElementById('price-display').classList.remove('show');
            document.getElementById('detail-btn').style.display = 'none';
            document.getElementById('alter-btn').style.display = 'none';
            document.getElementById('clear-screen-btn').style.display = 'none';
            makingOverride = null;
            currentMakingType = '';
            currentMakingInput = 0;
            currentBarcode = '';
            document.getElementById('barcode').focus();
            closeOptions();
        }

        function updateRemoveButton() {
            const stamp = document.getElementById('manage-stamp').value;
            const btn = document.getElementById('remove-stamp-btn');
            if (btn) {
                btn.disabled = !stamp || stamp === '-- No Stamps Defined --';
            }
        }
        function addStamp() {
            if (!checkPin()) return; // PIN check added
            const metal = document.getElementById('metal-select').value.toLowerCase();
            const newStamp = document.getElementById('new-stamp').value.trim().toUpperCase();
            if (!metal || !newStamp) {
                alert('Please select metal and enter stamp name');
                return;
            }
            if (!rates[metal]) {
                rates[metal] = {};
            }
            if (rates[metal][newStamp]) {
                alert('Stamp already exists');
                return;
            }
            rates[metal][newStamp] = 0;
            saveAllDataToCloud(); // SAVE TO CLOUD
            document.getElementById('new-stamp').value = '';
            alert(`Added ${newStamp} for ${metal}`);
        }
        function removeStamp() {
            if (!checkPin()) return; // PIN check added
            const metal = document.getElementById('metal-select').value.toLowerCase();
            const stamp = document.getElementById('manage-stamp').value;
            if (!stamp || stamp === '-- No Stamps Defined --') {
                alert('Please select a stamp to remove');
                return;
            }
            if (confirm(`Remove ${stamp} for ${metal.toUpperCase()}?`)) {
                delete rates[metal][stamp];
                saveAllDataToCloud(); // SAVE TO CLOUD
                alert(`Removed ${stamp}`);
            }
        }
        function renameStamp() {
            if (!checkPin()) return; // PIN check added
            const metal = document.getElementById('metal-select').value.toLowerCase();
            const oldStamp = document.getElementById('manage-stamp').value;
            const newName = document.getElementById('rename-to').value.trim().toUpperCase();
            if (!oldStamp || oldStamp === '-- No Stamps Defined --') {
                alert('Please select a stamp to rename');
                return;
            }
            if (!newName || newName === oldStamp) {
                alert('Please enter a different new name');
                return;
            }
            if (rates[metal][newName]) {
                alert('New name already exists');
                return;
            }
            rates[metal][newName] = rates[metal][oldStamp];
            delete rates[metal][oldStamp];
            saveAllDataToCloud(); // SAVE TO CLOUD
            document.getElementById('rename-to').value = '';
            alert(`Renamed ${oldStamp} to ${newName}`);
        }
        function loadExcel() {
            if (!checkPin()) { // PIN check added
                document.getElementById('excel-file').value = ''; 
                return; 
            }
            const file = document.getElementById('excel-file').files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                const json = XLSX.utils.sheet_to_json(sheet, {header: 1});
                const headers = (json[0] || []).map(h => (h || '').toString().trim().toLowerCase());
                const cols = {
                    tagNo: findColumn(headers, ['tag no', 'tagno', 'barcode']),
                    itemName: findColumn(headers, ['item name', 'name', 'product name', 'item']),
                    grossWeight: findColumn(headers, ['gr. wt.', 'gr wt', 'gross weight', 'gross wt', 'grossweight']),
                    netWeight: findColumn(headers, ['n. wt.', 'n wt', 'net weight', 'net wt', 'netweight']),
                    makingPct: findColumn(headers, ['making (%)', 'making%', 'making percent']),
                    mGram: findColumn(headers, ['making (per g)', 'making per g', 'making/g', 'mc/g']),
                    mPc: findColumn(headers, ['making (per pc)', 'making per pc', 'making/pc', 'mc/pc']),
                    mrp: findColumn(headers, ['mrp', 'price', 'selling price', 'final price']),
                    otherCharge: findColumn(headers, ['other charge', 'other', 'extra charge']),
                    metal: findColumn(headers, ['metal']),
                    stamp: findColumn(headers, ['stamp'])
                };
                if (cols.tagNo === -1) {
                    document.getElementById('excel-info').innerHTML = '<p style="color:red;">Error: Tag No column required</p>';
                    return;
                }
                let count = 0;
                let newProductData = {}; 
                for (let i = 1; i < json.length; i++) {
                    const row = json[i];
                    const tagNo = (row[cols.tagNo] || '').toString().trim().toUpperCase();
                    if (!tagNo) continue;
                    const grossWt = cols.grossWeight !== -1 ? parseFloat(row[cols.grossWeight]) || 0 : 0;
                    const netWt = cols.netWeight !== -1 ? parseFloat(row[cols.netWeight]) || 0 : grossWt;
                    newProductData[tagNo] = {
                        itemName: cols.itemName !== -1 ? (row[cols.itemName] || '').toString().trim() : '',
                        grossWeight: grossWt,
                        netWeight: netWt,
                        makingPercent: cols.makingPct !== -1 ? parseFloat(row[cols.makingPct]) || 0 : 0,
                        makingPerGram: cols.mGram !== -1 ? parseFloat(row[cols.mGram]) || 0 : 0,
                        makingPerPc: cols.mPc !== -1 ? parseFloat(row[cols.mPc]) || 0 : 0,
                        mrp: cols.mrp !== -1 ? parseFloat(row[cols.mrp]) || 0 : 0,
                        otherCharge: cols.otherCharge !== -1 ? parseFloat(row[cols.otherCharge]) || 0 : 0,
                        metal: cols.metal !== -1 ? (row[cols.metal] || '').toString().trim().toLowerCase() : '',
                        stamp: cols.stamp !== -1 ? (row[cols.stamp] || '').toString().trim().toUpperCase() : ''
                    };
                    count++;
                }
                productData = newProductData; 
                saveAllDataToCloud(); // SAVE TO CLOUD
                document.getElementById('excel-info').innerHTML = `<p>Loaded ${count} products</p>`;
            };
            reader.readAsArrayBuffer(file);
        }
        function findColumn(headers, names) {
            for (let i = 0; i < headers.length; i++) {
                for (let name of names) {
                    if (headers[i] === name.toLowerCase()) return i;
                }
            }
            return -1;
        }

        function updateRate() {
            if (!checkPin()) return; // PIN check added
            const metal = document.getElementById('metal-select').value.toLowerCase();
            const stamp = document.getElementById('stamp-select').value;
            const price = parseFloat(document.getElementById('price-per-gram').value);
            if (rates[metal] && rates[metal][stamp] !== undefined && !isNaN(price)) {
                rates[metal][stamp] = price;
                saveAllDataToCloud(); // SAVE TO CLOUD
                alert(`Updated: ${metal} ${stamp} → ₹${price}/g`);
                document.getElementById('price-per-gram').value = '';
                // Rerendering will happen automatically via Firebase listener
            } else {
                alert('Invalid input');
            }
        }
        function updateTax() {
            if (!checkPin()) return; // PIN check added
            const tax = parseFloat(document.getElementById('tax-percent').value);
            if (!isNaN(tax)) {
                taxRate = tax;
                saveAllDataToCloud(); // SAVE TO CLOUD
                alert(`Tax updated to ${tax}%`);
                document.getElementById('tax-percent').value = tax;
                // Rerendering will happen automatically via Firebase listener
            } else {
                alert('Invalid tax');
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            const metalSelect = document.getElementById('metal-select');
            metalSelect.addEventListener('change', () => {
                const value = metalSelect.value;
                populateStamps('stamp-select', value);
                populateStamps('manage-stamp', value);
                updateRemoveButton();
            });

            // Initial setup for the rates screen (will be overridden by syncData)
            populateStamps('stamp-select', 'Gold');
            populateStamps('manage-stamp', 'Gold');
            updateRemoveButton();
            document.getElementById('manage-stamp').addEventListener('change', updateRemoveButton);

            showSection('main');

            const barcodeInput = document.getElementById('barcode');
            
            // --- Global keydown listener for seamless scanning ---
            document.addEventListener('keydown', function(event) {
                // Only act on the main screen
                if (document.getElementById('main-screen').style.display !== 'flex') {
                    return;
                }
                // Check if the currently active element is already the barcode input.
                if (document.activeElement === barcodeInput) {
                    return; 
                }

                // Check if the keypress is a single character key (typical of scanner input) 
                if (event.key.length === 1 && !event.ctrlKey && !event.metaKey && !event.altKey) {
                    // Check if the active element is another input field where the user is typing 
                    const activeTag = document.activeElement.tagName.toLowerCase();
                    if (activeTag === 'input' || activeTag === 'textarea' || activeTag === 'select') {
                        return;
                    }
                    
                    // Steal focus to the barcode input so the scanner output is captured
                    barcodeInput.focus();
                }
            });
            // ---------------------------------------------------------


            // --- Existing keydown listener to trigger lookup only on Enter keypress ---
            barcodeInput.addEventListener('keydown', function(event) {
                if (event.key === 'Enter') { 
                    event.preventDefault();
                    const barcode = barcodeInput.value.trim().toUpperCase();
                    barcodeInput.value = ''; // Clear input
                    barcodeInput.focus(); // Refocus
                    lookupProduct(barcode); // Trigger lookup
                }
            });
            // --------------------------------------------------------------------------
            
            // At the end of the script, start the sync process
            syncData();
        });
        
    </script>
</body>
</html>
